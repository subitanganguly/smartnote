<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartNote V2</title>
    <link rel="icon" type="image/png" href="img/logo.png">
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="js/gradient-loader.js"></script>
    <script src="js/auth.js"></script>
    <style>
            .glass {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.199);
  }
    </style>
</head>
  <body>
     <div class="area" >
        <ul class="circles">
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
        </ul>

        <nav class="navbar bg-light fixed-top">
  <div class="container">
    <a class="navbar-brand" href="#">
    <img src="img/logo.png" alt="Bootstrap" width="40" height="34" class="brand-logo">
    <span id="greetingMessage" class="mb-0">Archive</span>
    </a>
    <div class="d-flex align-items-center">
        <a class="dropdown-item" alt="Log Out" href="#" id="logoutButton"><i class="fa-solid fa-right-from-bracket"></i></a>
    
    </div>
  </div>
   </nav>
  
   <div class="container main-content" style="margin-top: 80px;">
 
        
        <a href="all-expenses.html" style="text-decoration: none;">
        <div class="text-center text-light  glass zoom p-4">
            <span class="fw-bold">All Data</span>
        </div>
        </a>
        <center>
            <div id="loadingSpinner" class="loader mt-3" style="display: none;" role="status">
                <span class="sr-only"></span>
            </div>
        </center>
        

        <div id="yearList" class="row mt-3" style="display: none;"></div>
        
        <!-- No record found message -->
        <div id="noRecordMessage" class="text-center text-light mt-3 glass zoom" style="display: none;">
            No record found.
   
    </div>
    
    <script>
        

        const yearList = document.getElementById("yearList");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const noRecordMessage = document.getElementById("noRecordMessage");

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                const userId = user.uid;
                loadArchivedExpenses(userId);
            } else {
                console.log("User not authenticated. Redirecting to login...");
                window.location.href = "login.html";
            }
        });

        function loadArchivedExpenses(userId) {
            const archiveRef = firebase.database().ref(`archive_expenses/${userId}`);
            
            // Show loading spinner and hide year list and no record message
            loadingSpinner.style.display = "flex";
            yearList.style.display = "none";
            noRecordMessage.style.display = "none";

            archiveRef.once("value", (snapshot) => {
                const expensesByYear = {};

                snapshot.forEach((childSnapshot) => {
                    const expense = childSnapshot.val();
                    const year = new Date(expense.date).getFullYear();

                    if (!expensesByYear[year]) {
                        expensesByYear[year] = [];
                    }
                    expensesByYear[year].push(expense);
                });

                if (Object.keys(expensesByYear).length > 0) {
                    displayYears(expensesByYear);
                    yearList.style.display = "flex";
                } else {
                    noRecordMessage.style.display = "block";
                }

                // Hide loading spinner after data is loaded
                loadingSpinner.style.display = "none";
            });
        }

        function displayYears(expensesByYear) {
            yearList.innerHTML = "";

            Object.keys(expensesByYear).sort((a, b) => b - a).forEach((year) => {
                const colDiv = document.createElement("div");
                colDiv.classList.add("col-6", "col-md-6", "mb-4");

                const cardLink = document.createElement("a");
                cardLink.href = `yearly_expenses.html?year=${year}`;
                cardLink.classList.add("card", "glass","zoom", "text-decoration-none", "text-light", "text-center",);

                const cardBody = document.createElement("div");
                cardBody.classList.add("glass","p-4");

                const cardTitle = document.createElement("h5");
                cardTitle.classList.add("card-title");
                cardTitle.textContent = `${year} Data`;

                cardBody.appendChild(cardTitle);
                cardLink.appendChild(cardBody);
                colDiv.appendChild(cardLink);
                yearList.appendChild(colDiv);
            });
        }
    </script>
    <script>
        // Log out function
        document.getElementById("logoutButton").addEventListener("click", () => {
               firebase.auth().signOut().then(() => {
                   window.location.href = "login.html";
               }).catch((error) => {
                   alert("Error logging out: " + error.message);
               });
           });

           // back Button
function goBack() {
    if (window.history.length > 1) {
        window.history.back();
    } else {
        window.location.href = "defaultPage.html"; // Redirect to a default page
    }
}



   </script>
  

   </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
  </body>
</html>