<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Details - Barman Construction</title>
    <link rel="icon" type="image/png" href="img/tab-logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="js/firebaseconfig.js"></script>
</head>
<body class="bg-light">
    <div class="container-fluid py-3">
        <!-- Back Button -->
        <div class="mb-3">
            <button class="btn btn-outline-secondary" onclick="window.close()">
                <i class="fas fa-arrow-left me-1"></i> Back to Report
            </button>
        </div>

        <!-- Header Card -->
        <div class="card shadow-sm mb-4 border-start border-primary border-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="card-title mb-1" id="clientNameHeader">Client Details</h4>
                        <p class="text-muted mb-0" id="clientDetailsSubtitle">Loading client information...</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="bg-light d-inline-block px-3 py-2 rounded">
                            <small class="text-muted d-block">Total Documents</small>
                            <span class="fw-bold fs-5" id="totalDocuments">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Date Filter -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Date Filter</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">From Date</label>
                        <input type="date" class="form-control" id="fromDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">To Date</label>
                        <input type="date" class="form-control" id="toDate">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="applyDateFilter()">
                            <i class="fas fa-filter me-2"></i>Apply Filter
                        </button>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-secondary w-100" onclick="clearDateFilter()">
                            <i class="fas fa-times me-2"></i>Clear Filter
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Total Payment In (Received)</h6>
                        <h4 class="card-title text-success" id="totalReceived">₹0.00</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Total Payment Out (Paid)</h6>
                        <h4 class="card-title text-danger" id="totalPaid">₹0.00</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Balance</h6>
                        <h4 class="card-title" id="netBalance">₹0.00</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Document Count</h6>
                        <div class="d-flex justify-content-center align-items-center">
                            <h4 class="card-title me-2">
                                <span class="text-primary" id="taxInvoiceCount">0</span> /
                                <span class="text-danger" id="purchaseInvoiceCount">0</span>
                            </h4>
                        </div>
                        <small class="text-muted">Tax / Purchase</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="card-title mb-0">Transaction Details</h5>

    <div class="d-flex gap-2">
        <div class="text-muted" id="dateRangeText"></div>

        <button class="btn btn-sm btn-success" onclick="downloadStatementPDF()">
            <i class="fas fa-file-pdf me-1"></i> Download Statement
        </button>
    </div>
</div>

                <div class="table-responsive">
                    <table class="table table-hover" id="clientTransactionsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Invoice Type</th>
                                <th>Invoice No</th>
                                <th>Date</th>
                                <th>Payment In (Received)</th>
                                <th>Payment Out (Paid)</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <tr id="loadingRow">
                                <td colspan="7" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading transactions...</p>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot id="tableFooter" style="display: none;">
                            <tr class="table-active fw-bold">
                                <td colspan="3" class="text-end">TOTAL:</td>
                                <td id="footerReceived" class="text-success">₹0.00</td>
                                <td id="footerPaid" class="text-danger">₹0.00</td>
                                <td id="footerBalance">₹0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase initialization
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Document type configuration
        const documentTypes = {
            'tax-invoice': { label: 'Tax Invoice', type: 'incoming', color: '#28a745' },
            'purchase-invoice': { label: 'Purchase Invoice', type: 'outgoing', color: '#dc3545' }
        };

        // Global variables
        let allClientDocuments = [];
        let filteredClientDocuments = [];
        let clientName = '';
        let currentFilter = {
            fromDate: null,
            toDate: null
        };

        // Check authentication
        firebase.auth().onAuthStateChanged(user => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                loadClientData();
            }
        });

        // Get client name from URL parameter
        function getClientNameFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const clientName = urlParams.get('client');
            return clientName ? decodeURIComponent(clientName) : null;
        }

        // Load client data from Firebase
        async function loadClientData() {
            clientName = getClientNameFromURL();
            if (!clientName) {
                showError('No client specified');
                return;
            }

            try {
                // Update header
                document.getElementById('clientNameHeader').textContent = clientName;
                document.getElementById('clientDetailsSubtitle').textContent = 'Transaction history for tax and purchase invoices';

                // Load all bills
                const billsRef = firebase.database().ref('bill');
                const snapshot = await billsRef.once('value');
                
                if (!snapshot.exists()) {
                    showError('No data found');
                    return;
                }
                
                // Process bills
                allClientDocuments = [];
                
                snapshot.forEach(childSnapshot => {
                    const bill = childSnapshot.val();
                    bill.id = childSnapshot.key;
                    
                    if (!bill.isArchived && bill.clientName === clientName) {
                        const docType = bill.documentType;
                        
                        if (docType === 'tax-invoice' || docType === 'purchase-invoice') {
                            const amount = parseFloat(bill.grandTotal || bill.invoiceTotal || 0);
                            const dateStr = bill.invoiceDate || bill.createdAt;
                            
                            allClientDocuments.push({
                                id: bill.id,
                                invoiceNo: bill.invoiceNo || 'N/A',
                                date: dateStr,
                                type: docType,
                                typeLabel: documentTypes[docType].label,
                                amount: amount,
                                paymentIn: docType === 'tax-invoice' ? amount : 0,
                                paymentOut: docType === 'purchase-invoice' ? amount : 0,
                                rawDate: new Date(dateStr)
                            });
                        }
                    }
                });
                
                if (allClientDocuments.length === 0) {
                    showError(`No Tax Invoices or Purchase Invoices found for client: ${clientName}`);
                    return;
                }
                
                // Sort by date
                allClientDocuments.sort((a, b) => a.rawDate - b.rawDate);
                
                // Set default date filter to show all data
                setDefaultDateRange();
                
                // Apply initial filter
                applyDateFilter();
                
            } catch (error) {
                console.error('Error loading client data:', error);
                showError('Failed to load client data: ' + error.message);
            }
        }

        // Set default date range based on data
        function setDefaultDateRange() {
            if (allClientDocuments.length === 0) return;
            
            // Find min and max dates
            const dates = allClientDocuments.map(doc => doc.rawDate);
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            // Set date inputs
            document.getElementById('fromDate').valueAsDate = minDate;
            document.getElementById('toDate').valueAsDate = maxDate;
            
            // Update current filter
            currentFilter.fromDate = minDate;
            currentFilter.toDate = maxDate;
            
            updateDateRangeText();
        }

        // Apply date filter
        function applyDateFilter() {
            const fromDateInput = document.getElementById('fromDate');
            const toDateInput = document.getElementById('toDate');
            
            let fromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
            let toDate = toDateInput.value ? new Date(toDateInput.value) : null;
            
            // Validate date range
            if (fromDate && toDate && fromDate > toDate) {
                alert('From date cannot be after To date');
                return;
            }
            
            // Reset to all dates if no filter
            if (!fromDate && !toDate) {
                filteredClientDocuments = [...allClientDocuments];
            } else {
                // Filter documents
                filteredClientDocuments = allClientDocuments.filter(doc => {
                    const docDate = doc.rawDate;
                    let match = true;
                    
                    if (fromDate) {
                        // Set fromDate to beginning of day
                        const fromDateStart = new Date(fromDate);
                        fromDateStart.setHours(0, 0, 0, 0);
                        match = match && docDate >= fromDateStart;
                    }
                    
                    if (toDate) {
                        // Set toDate to end of day
                        const toDateEnd = new Date(toDate);
                        toDateEnd.setHours(23, 59, 59, 999);
                        match = match && docDate <= toDateEnd;
                    }
                    
                    return match;
                });
            }
            
            // Update current filter
            currentFilter.fromDate = fromDate;
            currentFilter.toDate = toDate;
            
            // Update UI
            updateDateRangeText();
            calculateAndDisplayData();
        }

        // Clear date filter
        function clearDateFilter() {
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            applyDateFilter();
        }

        // Update date range text
        function updateDateRangeText() {
            const rangeText = document.getElementById('dateRangeText');
            
            if (!currentFilter.fromDate && !currentFilter.toDate) {
                rangeText.textContent = 'Showing all dates';
            } else {
                let text = 'Showing: ';
                if (currentFilter.fromDate) {
                    text += formatDateDisplay(currentFilter.fromDate);
                } else {
                    text += 'Beginning';
                }
                
                text += ' to ';
                
                if (currentFilter.toDate) {
                    text += formatDateDisplay(currentFilter.toDate);
                } else {
                    text += 'Now';
                }
                
                rangeText.textContent = text;
            }
        }

        // Calculate and display data
        function calculateAndDisplayData() {
            if (filteredClientDocuments.length === 0) {
                showNoDataMessage();
                return;
            }
            
            // Calculate totals
            let clientData = {
                incoming: 0,
                outgoing: 0,
                documents: [],
                taxInvoiceCount: 0,
                purchaseInvoiceCount: 0,
                runningBalance: 0
            };
            
            // Sort filtered documents by date
            const sortedDocs = [...filteredClientDocuments].sort((a, b) => a.rawDate - b.rawDate);
            
            // Calculate running balance
            let runningBalance = 0;
            
            sortedDocs.forEach(doc => {
                if (doc.type === 'tax-invoice') {
                    clientData.incoming += doc.amount;
                    clientData.taxInvoiceCount++;
                    runningBalance += doc.amount;
                } else if (doc.type === 'purchase-invoice') {
                    clientData.outgoing += doc.amount;
                    clientData.purchaseInvoiceCount++;
                    runningBalance -= doc.amount;
                }
                
                clientData.documents.push({
                    ...doc,
                    balance: runningBalance
                });
            });
            
            clientData.balance = runningBalance;
            clientData.totalDocuments = sortedDocs.length;
            
            // Update summary cards
            updateSummaryCards(clientData);
            
            // Render table
            renderTransactionsTable(clientData);
        }

        // Show no data message
        function showNoDataMessage() {
            const tableBody = document.getElementById('transactionsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5>No Transactions Found</h5>
                        <p class="text-muted">No transactions match the current filter criteria.</p>
                    </td>
                </tr>
            `;
            
            // Reset summary cards
            document.getElementById('totalReceived').textContent = '₹0.00';
            document.getElementById('totalPaid').textContent = '₹0.00';
            document.getElementById('netBalance').textContent = '₹0.00';
            document.getElementById('taxInvoiceCount').textContent = '0';
            document.getElementById('purchaseInvoiceCount').textContent = '0';
            document.getElementById('totalDocuments').textContent = '0';
            
            // Hide footer
            document.getElementById('tableFooter').style.display = 'none';
        }

        // Format currency
        function formatCurrency(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) amount = 0;
            return '₹' + amount.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Format date for display
        function formatDateDisplay(date) {
            try {
                const d = new Date(date);
                const day = d.getDate().toString().padStart(2, '0');
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const year = d.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                return 'Invalid Date';
            }
        }

        // Format date for table
        function formatDateTable(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                return dateString;
            }
        }

        // Update summary cards
        function updateSummaryCards(clientData) {
            document.getElementById('totalReceived').textContent = formatCurrency(clientData.incoming);
            document.getElementById('totalPaid').textContent = formatCurrency(clientData.outgoing);
            
            const balanceElement = document.getElementById('netBalance');
            balanceElement.textContent = formatCurrency(clientData.balance);
            balanceElement.className = clientData.balance >= 0 ? 'card-title text-success' : 'card-title text-danger';
            
            document.getElementById('taxInvoiceCount').textContent = clientData.taxInvoiceCount;
            document.getElementById('purchaseInvoiceCount').textContent = clientData.purchaseInvoiceCount;
            document.getElementById('totalDocuments').textContent = clientData.totalDocuments;
        }

        

        // Render transactions table
        function renderTransactionsTable(clientData) {
            const tableBody = document.getElementById('transactionsTableBody');
            tableBody.innerHTML = '';
            
            clientData.documents.forEach(doc => {
                const row = document.createElement('tr');
                
                // Invoice Type
                const typeCell = document.createElement('td');
                const badge = document.createElement('span');
                badge.className = `badge ${doc.type === 'tax-invoice' ? 'bg-success' : 'bg-danger'}`;
                badge.textContent = doc.typeLabel;
                typeCell.appendChild(badge);
                
                // Invoice No
                const invoiceNoCell = document.createElement('td');
                invoiceNoCell.textContent = doc.invoiceNo;
                invoiceNoCell.className = 'font-monospace';
                
                // Date
                const dateCell = document.createElement('td');
                dateCell.textContent = formatDateTable(doc.date);
                
                // Payment In (Received)
                const paymentInCell = document.createElement('td');
                if (doc.paymentIn > 0) {
                    paymentInCell.textContent = formatCurrency(doc.paymentIn);
                    paymentInCell.className = 'text-success fw-bold';
                } else {
                    paymentInCell.textContent = '-';
                    paymentInCell.className = 'text-muted';
                }
                
                // Payment Out (Paid)
                const paymentOutCell = document.createElement('td');
                if (doc.paymentOut > 0) {
                    paymentOutCell.textContent = formatCurrency(doc.paymentOut);
                    paymentOutCell.className = 'text-danger fw-bold';
                } else {
                    paymentOutCell.textContent = '-';
                    paymentOutCell.className = 'text-muted';
                }
                
                // Balance
                const balanceCell = document.createElement('td');
                balanceCell.textContent = formatCurrency(doc.balance);
                balanceCell.className = doc.balance >= 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
                
                // Actions
                const actionsCell = document.createElement('td');
                const viewButton = document.createElement('button');
                viewButton.className = 'btn btn-sm btn-outline-primary';
                viewButton.innerHTML = '<i class="fas fa-eye"></i>';
                viewButton.title = 'View Document';
                viewButton.onclick = function() {
                    window.open(`bill.html?billId=${doc.id}`, '_blank');
                };
                actionsCell.appendChild(viewButton);
                
                // Append all cells
                row.appendChild(typeCell);
                row.appendChild(invoiceNoCell);
                row.appendChild(dateCell);
                row.appendChild(paymentInCell);
                row.appendChild(paymentOutCell);
                row.appendChild(balanceCell);
                row.appendChild(actionsCell);
                
                tableBody.appendChild(row);
            });
            
            // Update footer
            const footer = document.getElementById('tableFooter');
            footer.style.display = 'table-row-group';
            
            document.getElementById('footerReceived').textContent = formatCurrency(clientData.incoming);
            document.getElementById('footerPaid').textContent = formatCurrency(clientData.outgoing);
            
            const footerBalance = document.getElementById('footerBalance');
            footerBalance.textContent = formatCurrency(clientData.balance);
            footerBalance.className = clientData.balance >= 0 ? 'text-success' : 'text-danger';
        }

        // Show error message
        function showError(message) {
            const tableBody = document.getElementById('transactionsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <i class="fas fa-exclamation-triangle text-danger fa-3x mb-3"></i>
                        <h5>Error Loading Data</h5>
                        <p class="text-muted">${message}</p>
                        <button class="btn btn-primary mt-3" onclick="window.close()">
                            <i class="fas fa-arrow-left me-1"></i> Back to Report
                        </button>
                    </td>
                </tr>
            `;
            
            document.getElementById('tableFooter').style.display = 'none';
        }

        // Close window with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                window.close();
            }
        });

function getTotalReceived() {
    return filteredClientDocuments.reduce((sum, d) => sum + (d.paymentIn || 0), 0);
}

function getTotalPaid() {
    return filteredClientDocuments.reduce((sum, d) => sum + (d.paymentOut || 0), 0);
}

function getNetBalance() {
    return getTotalReceived() - getTotalPaid();
}



function downloadStatementPDF() {
    if (!currentFilter.fromDate || !currentFilter.toDate) {
        alert('Please apply date filter before downloading.');
        return;
    }

    if (!filteredClientDocuments.length) {
        alert('No data available for selected date.');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    let y = 15;

    // ===== HEADER =====
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.text('BARMAN CONSTRUCTION', 105, y, { align: 'center' });

    y += 8;
    doc.setFontSize(11);
    doc.text('Client Statement', 105, y, { align: 'center' });

    y += 10;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.text(`Client Name : ${clientName}`, 14, y);
    doc.text(
        `Period : ${formatDateDisplay(currentFilter.fromDate)} to ${formatDateDisplay(currentFilter.toDate)}`,
        14,
        y + 6
    );

    // ===== SUMMARY BOX =====
    y += 15;
    doc.setFillColor(245, 245, 245);
    doc.rect(14, y, 182, 24, 'F');

    // Received (GREEN)
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(40, 167, 69);
    doc.text(`Total Received : Rs. ${getTotalReceived().toFixed(2)}`, 18, y + 8);

    // Paid (RED)
    doc.setTextColor(220, 53, 69);
    doc.text(`Total Paid : Rs. ${getTotalPaid().toFixed(2)}`, 18, y + 14);

    // Balance (Auto color)
    const balance = getNetBalance();
    doc.setTextColor(balance >= 0 ? 40 : 220, balance >= 0 ? 167 : 53, balance >= 0 ? 69 : 69);
    doc.text(`Balance : Rs. ${balance.toFixed(2)}`, 120, y + 11);

    doc.setTextColor(0, 0, 0); // reset color

    // ===== TABLE WITH BALANCE COLUMN =====
    y += 32;

    let runningBalance = 0;

    const tableBody = filteredClientDocuments.map(d => {
        if (d.type === 'tax-invoice') runningBalance += d.amount;
        if (d.type === 'purchase-invoice') runningBalance -= d.amount;

        return [
            formatDateTable(d.date),
            d.typeLabel,
            d.invoiceNo,
            d.paymentIn ? `Rs. ${d.paymentIn.toFixed(2)}` : '-',
            d.paymentOut ? `Rs. ${d.paymentOut.toFixed(2)}` : '-',
            `Rs. ${runningBalance.toFixed(2)}`
        ];
    });

    doc.autoTable({
    startY: y,
    head: [[
        'Date',
        'Type',
        'Invoice No',
        'Received',
        'Paid',
        'Balance'
    ]],
    body: tableBody,
    styles: {
        font: 'helvetica',
        fontSize: 9,
        cellPadding: 3
    },
    headStyles: {
        fillColor: [33, 37, 41],
        textColor: 255,
        halign: 'center' // CENTER all header text
    },
    columnStyles: {
        0: { halign: 'left' },
        1: { halign: 'left' },
        2: { halign: 'left' },

        // Numbers stay RIGHT aligned
        3: { halign: 'right', textColor: [40, 167, 69] }, // Received
        4: { halign: 'right', textColor: [220, 53, 69] }, // Paid
        5: { halign: 'right' } // Balance
    },
    didParseCell: function (data) {
        // Balance color auto
        if (data.section === 'body' && data.column.index === 5) {
            if (data.cell.raw.includes('-')) {
                data.cell.styles.textColor = [220, 53, 69];
            } else {
                data.cell.styles.textColor = [40, 167, 69];
            }
        }
    }
});


    // ===== FOOTER =====
    const pageHeight = doc.internal.pageSize.height;
    doc.setFontSize(8);
    doc.setTextColor(120);
    doc.text(
        `Generated on: ${new Date().toLocaleString()}`,
        14,
        pageHeight - 10
    );

    doc.save(`Statement_${clientName}.pdf`);
}


    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

</body>
</html>