<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
     <meta name="viewport">
    <title>Barman Construction - Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="img/tab-logo.png">
    <style>
        /* A4 Paper Size */
        @media print {
            @page {
                size: A4;
                margin: 0.5cm;
            }
            
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                background: white !important;
            }
            
            .container-fluid {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            /* Fix for print layout */
            .a4-container {
                box-shadow: none !important;
                border-radius: 0 !important;
            }
            
            /* Ensure columns display properly in print */
            .row {
                display: flex !important;
                flex-wrap: wrap !important;
            }
            
            .col-1, .col-2, .col-3, .col-4, .col-5, .col-6, 
            .col-7, .col-8, .col-9, .col-10, .col-11, .col-12 {
                float: none !important;
                display: block !important;
            }
            
            /* Transportation and Bank details print fix */
            #transportationInfo .col-md-2,
            #bankDetailsInfo .col-md-2 {
                display: inline-block !important;
                width: 25% !important;
            }

  
                /* Third column (QR Code) */
            .company-header .col-md-2 {
                width: 25% !important;
                max-width: 25% !important;
                flex: 0 0 25% !important;
                padding-left: 10px !important;
            }
            
            .company-header .col-6 {
                width: 50% !important;
                flex: 0 0 50% !important;
                display: block !important;
            }
            
            .company-header .col-md-2 {
                width: 30.333333% !important;
                flex: 0 0 33.333333% !important;
                display: block !important;
            }
            
            /* Document type specific print styles */
            body[data-document-type*="cash memo"] .footer-section,
            body[data-document-type*="cash memo"] .company-header {
                display: none !important;
            }
            
            /* Hide Received By and Delivered By for non-Delivery Challan documents */
            body:not([data-document-type*="delivery challan"]) .received-by-section,
            body:not([data-document-type*="delivery challan"]) .delivered-by-section {
                display: none !important;
            }
            
            /* Delivery Challan specific footer layout */
            body[data-document-type*="delivery challan"] .footer-section .footer-row {
                display: flex !important;
                flex-wrap: nowrap !important;
            }
            
            body[data-document-type*="delivery challan"] .footer-section .col-3 {
                width: 25% !important;
                flex: 0 0 25% !important;
                display: block !important;
            }
            
            body[data-document-type*="delivery challan"] .footer-section .col-8 {
                width: 25% !important;
                flex: 0 0 25% !important;
                display: block !important;
            }
            
            /* Non-Delivery Challan footer layout */
            body:not([data-document-type*="delivery challan"]) .footer-section .footer-row {
                display: flex !important;
                flex-wrap: nowrap !important;
            }
            
            body:not([data-document-type*="delivery challan"]) .footer-section .col-8 {
                width: 66.666667% !important;
                flex: 0 0 66.666667% !important;
                display: block !important;
            }
            
            body:not([data-document-type*="delivery challan"]) .footer-section .authorized-col {
                width: 33.333333% !important;
                flex: 0 0 33.333333% !important;
                display: block !important;
            }

        }
        
        @media screen {
            body {
                background-color: #f8f9fa;
                padding: 20px 0;
            }
            
            .print-only {
                display: none !important;
            }
            
            .a4-container {
                background: white;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
                border-radius: 8px;
                overflow: hidden;
            }
            
            /* Document type specific screen styles */
            body[data-document-type*="cash memo"] .footer-section,
            body[data-document-type*="cash memo"] .company-header {
                display: none !important;
            }
        }
        
        /* A4 Dimensions */
        .a4-container {
            width: 21cm;
            min-height: auto;
            padding: 1.5cm;
            margin: 0 auto;
            background: white;
            position: relative;
        }
        
        .company-name {
            font-size: 18px;
            font-weight: 700;
            color: #001b44;
            margin: 0;
        }
        
        .company-tagline {
            font-size: 14px;
            color: #6c757d;
        }
        
        .company-details {
            font-size: 11px;
        }
        
        .company-details p {
            margin-bottom: 0px;
        }
        
        /* Document Title */
        .document-title {
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: #050036;
            margin: 3px 0;
            background-color: #f8f9fa;
            border: 2px solid #00381e;
        }
        
        /* Section Styles */
        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: rgb(0, 0, 0);
            background-color: #dfdfdf;
            padding: 2px 5px;
            border-radius: 0px;
            margin: 0px 0 0px 0;
        }
        
        /* Fix for equal height columns */
        .equal-height-row {
            display: flex;
            flex-wrap: wrap;
        }
        
        .equal-height-col {
            display: flex;
            flex-direction: column;
        }
        
        .info-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        #billToInfo, #documentDetailsInfo {
            font-size: 11px;
            padding: 5px;
            background-color: #f6f6f7;
            flex: 1;
            min-height: 80px; /* Ensure minimum height */
        }
        
        #transportationInfo, #bankDetailsInfo, #shipToAddress {
            background-color: #f6f6f7;
            padding: 5px;
            font-size: 11px;
            display: flex;
            flex-wrap: wrap;
        }
        
        #transportationInfo .col-md-3,
        #bankDetailsInfo .col-md-3 {
            flex: 0 0 25%;
            max-width: 25%;
            padding: 0 5px;
        }
        
        .info-row {
            margin-bottom: 1px;
        }
        
        .info-label {
            font-weight: 600;
            color: #000000;
        }
        
        .info-value {
            color: #212529;
        }
        
        /* Table Styles */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 5px 0;
            font-size: 11px;
        }
        
        .items-table th {
            background-color: #343a40;
            color: white;
            font-weight: 600;
            padding: 2px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .items-table td {
            padding: 8px 10px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .items-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .text-right {
            text-align: right !important;
        }
        
        /* Totals Section - Updated order */
        .totals-section {
            margin-top: 2px;
        }
        
        .amount-row {
            margin-bottom: 2px;
            font-size: 12px;
        }
        
        .amount-label {
            text-align: right;
            font-weight: 600;
        }
        
        .amount-value {
            text-align: right;
            font-weight: 500;
        }
        
        .grand-total {
            font-size: 12px;
            font-weight: 700;
            color: #198754;
            border-top: 2px solid #198754;
            padding-top: 2px;
            margin-top: 2px;
        }
        
        /* Footer Styles */
        .footer-section {
            margin-top: 5px;
            border-top: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            padding-top: 5px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .footer-row {
            display: flex;
            flex-wrap: wrap;
        }
        
        .authorized-sign {
            text-align: center;
            margin-top: 90px;
            
        }
        
        .signature-line {
            width: 150px;
            border-top: 1px solid #000;
            margin-right: 10px;
            display: none;
        }
        
        /* Action Buttons */
        .action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .btn-print {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .qr-text{
            font-size: 10px;
        }
        
        /* Responsive */
        @media (max-width: 21cm) {
            .a4-container {
                width: 100%;
                padding: 15px;
            }
            
            #transportationInfo .col-md-3,
            #bankDetailsInfo .col-md-3 {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }

        .pdf-mode {
    padding-top: 10mm !important;
}

    </style>
</head>
<body>
    <!-- Action Buttons -->
    <div class="action-buttons no-print">
        <div class="btn-group-vertical" role="group">
            <button id="printBtn" class="btn btn-primary btn-print" title="Print Document">
                <i class="fas fa-print"></i>
            </button>
            <button id="pdfBtn" class="btn btn-success btn-print mt-2" title="Download PDF">
                <i class="fas fa-file-pdf"></i>
            </button>

            <button id="backBtn" class="btn btn-secondary btn-print mt-2" title="Go Back">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
    </div>

    <div class="container-fluid">
        <div class="a4-container">
            <!-- Company Header -->
            <div class="row company-header">
                <div class="col-3">
                    <img src="img/logo-bill.jpeg" width="132px">
                </div>
                <div class="col-6">
                    <h6 class="company-name">Barman Construction</h6>
                    <p class="company-tagline">Quality Construction Services</p>
                    <span class="company-details">
                        <p><i class="fas fa-map-marker-alt me-1"></i>GOSHALA MORE, MAHUT PARA, DANGUAJHAR <br> Jalpaiguri, West Bengal - 735101</p>
                        <p><i class="fas fa-phone me-1"></i> +91 1234567890 <span><i class="fas fa-envelope me-1"></i> barmanconstruction2000@gmail.com</span></p>
                        
                        <p><i class="fas fa-shield-alt me-1"></i> GSTIN: 19ABCDE1234F1Z5</p>
                    </span>
                </div>
                <div class="col-md-2 text-center">
                        <p class="mb-1" style="font-size: 9px;"><strong>Generated On:</strong> <span id="generatedDate">Loading...</span></p>
                        <img class="mt-1 d-none" src="${qrUrl}" style="width:80px;">
                        <div class="bold mb-1 qr-text d-none">Scan to View Bill</div>
                </div>
            </div>

            <!-- Document Title -->
            <div class="document-title" id="documentTitle">
                TAX INVOICE
            </div>

            <!-- Bill To & Document Details - Equal Height Fix -->
            <div class="row equal-height-row">
                <!-- Bill To Information -->
                <div class="col-6 equal-height-col">
                    <div class="section-title">
                        <i class="fas fa-user-tie me-2"></i><span id="billToSectionTitle">Bill To Information</span>
                    </div>
                    <div class="info-container" id="billToInfo">
                        <!-- Bill To info will be loaded here -->
                    </div>
                </div>
                
                <!-- Document Details -->
                <div class="col-6 equal-height-col">
                    <div class="section-title">
                        <i class="fas fa-file-invoice me-2"></i><span id="documentDetailsTitle">Invoice Details</span>
                    </div>
                    <div class="info-container" id="documentDetailsInfo">
                        <!-- Document details will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Ship To Information (if exists) -->
            <div id="shipToSection" style="display: none;">
                <div class="section-title mt-1">
                    <i class="fas fa-shipping-fast me-2"></i>Ship To Information
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="info-row">
                            <div class="info-value" id="shipToAddress"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transportation Details (if exists) -->
            <div id="transportationSection" style="display: none;">
                <div class="section-title mt-1">
                    <i class="fas fa-truck me-2"></i>Transportation Details
                </div>
                <div class="row" >
                    <div class="col-12">
                        <div class="info-row">
                            <div class="info-value" id="transportationInfo"></div>
                        </div>
                    </div>
                    <!-- Transportation details will be loaded here -->
                </div>
            </div>

            <!-- Document Items -->
            <div class="section-title mt-1">
                <i class="fas fa-boxes me-2"></i>Document Items
            </div>
            <table class="items-table" id="itemsTable">
                <thead>
                    <tr>
                        <th width="5%">S.No</th>
                        <th width="35%">Item Name</th>
                        <th width="10%">HSN/SAC</th>
                        <th width="10%">Quantity</th>
                        <th width="10%">Unit</th>
                        <th width="15%">Price/Unit (₹)</th>
                        <th width="15%">Amount (₹)</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    <!-- Items will be loaded here -->
                </tbody>
            </table>

            <!-- Totals Section with CGST/SGST above tax -->
            <div class="row totals-section">
                <div class="col-7"></div>
                <div class="col-5">
                    <!-- Subtotal -->
                    <div class="amount-row row">
                        <div class="col-6 amount-label">Subtotal:</div>
                        <div class="col-6 amount-value">₹ <span id="subtotalAmount">0.00</span></div>
                    </div>
                    
                    <!-- Discount Row (if exists) -->
                    <div id="discountRow" style="display: none;">
                        <div class="amount-row row">
                            <div class="col-6 amount-label">Discount (<span id="discountPercent">0</span>%):</div>
                            <div class="col-6 amount-value">₹ <span id="discountAmount">0.00</span></div>
                        </div>
                        
                        <div class="amount-row row">
                            <div class="col-6 amount-label">Total After Discount:</div>
                            <div class="col-6 amount-value">₹ <span id="totalAfterDiscount">0.00</span></div>
                        </div>
                    </div>
                    
                    <!-- Tax Breakdown (CGST/SGST or IGST) -->
                    <div id="taxBreakdownDetails">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <!-- Total Tax -->
                    <div class="amount-row row">
                        <div class="col-6 amount-label">Total Tax (<span id="taxRate">0</span>%):</div>
                        <div class="col-6 amount-value">₹ <span id="taxAmount">0.00</span></div>
                    </div>
                    
                    <!-- Grand Total -->
                    <div class="amount-row row grand-total">
                        <div class="col-6 amount-label">GRAND TOTAL:</div>
                        <div class="col-6 amount-value">₹ <span id="grandTotal">0.00</span></div>
                    </div>
                </div>
            </div>

            <!-- Bank Details (if exists) -->
            <div id="bankDetailsSection" style="display: none;">
                <div class="section-title mt-1">
                    <i class="fas fa-university me-2"></i>Bank Details
                </div>
                <div class="row" >
                    <!-- Bank details will be loaded here -->
                     <div class="col-12">
                        <div class="info-row">
                            <div class="info-value" id="bankDetailsInfo"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Information (if exists) -->
            <div id="additionalInfoSection" style="display: none;">
                <div class="section-title mt-1">
                    <i class="fas fa-info-circle me-2"></i>Additional Information
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="info-value" id="additionalInfo"></div>
                    </div>
                </div>
            </div>


            <!-- Terms & Conditions -->
            <div class="footer-section">
                <div class="footer-row">
                    <div class="col-8 terms-section">
                        <div class="fw-bold">Terms & Conditions:</div>                       
                        <ul  style="font-size: 11px;">
                            <li>Thank you for doing business with us</li>
                       </ul>
                    </div> 
                    <div class="col-3 d-none received-by-section">
                        <div class="fw-bold">Received By:</div>
                        <ul style="font-size: 11px;">
                            <li>Name:</li>
                            <li>Comment:</li>
                            <li>Date:</li>
                            <li>Signature:</li>
                       </ul>
                    </div> 
                    <div class="col-3 d-none delivered-by-section">
                        <div class="fw-bold">Delivered By:</div>
                        <ul style="font-size: 11px;">
                            <li>Name:</li>
                            <li>Comment:</li>
                            <li>Date:</li>
                            <li>Signature:</li>
                       </ul>
                    </div> 
                    <div class="col-3 authorized-col"> 
                        <div class="authorized-sign">
                            <div class="signature-line"></div>
                            <p class=" fw-bold mb-0">Authorized Signatory</p>
                            <p class="mb-0"><small>Barman Construction</small></p>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-4">
                            <p class="mb-0"><small>This is a computer generated document. No signature required.</small></p>
                            <p class="mb-0"><small>Generated by Barman Construction Software</small></p>
                        </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="js/firebaseconfig.js"></script>
    
    <script>
       // Initialize Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

let documentTypeConfig = null;

async function loadDocumentTypesConfig() {
    if (documentTypeConfig) return documentTypeConfig;
    
    const res = await fetch('/js/document-types.json');
    const json = await res.json();
    documentTypeConfig = json;
    return json;
}

// Get bill ID from URL
const urlParams = new URLSearchParams(window.location.search);
const billId = urlParams.get('billId');

// Check authentication
firebase.auth().onAuthStateChanged(user => {
    if (!user) {
        window.location.href = "login.html";
    } else if (billId) {
        loadBillData(billId);
    } else {
        document.getElementById('documentTitle').textContent = 'Document Not Found';
        showStatus('No document ID provided', 'danger');
    }
});

// Load bill data
async function loadBillData(billId) {
    try {
        const billRef = firebase.database().ref(`bill/${billId}`);
        const snapshot = await billRef.once('value');
        
        if (!snapshot.exists()) {
            showStatus('Document not found', 'danger');
            return;
        }
        
        const billData = snapshot.val();
        console.log('Bill Data:', billData);
        
        // Display the data
        await displayBillData(billData, billId);
        
    } catch (error) {
        console.error('Error loading bill:', error);
        showStatus('Error loading document', 'danger');
    }
}

// Display bill data
async function displayBillData(data, billId) {
    try {
        // Set generated date
        const generatedDate = data.createdAt ? new Date(data.createdAt) : new Date();
        document.getElementById('generatedDate').textContent = generatedDate.toLocaleDateString('en-GB') + ' ' + generatedDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        
        // Set document type
        const documentTitle = data.documentTitle || 'DOCUMENT';
        document.getElementById('documentTitle').textContent = documentTitle;

        // Convert title → key (Tax Invoice → tax-invoice)
        const docTypeKey = documentTitle
            .toLowerCase()
            .replace(/\s+/g, '-');

        document.body.setAttribute('data-document-type', docTypeKey);

        // Handle document layout
        handleDocumentType(docTypeKey);

        // Load config and apply document type settings
        await loadAndApplyDocumentTypeSettings(docTypeKey);
        
        // Store document type in data attribute for CSS
        const docType = documentTitle.toLowerCase();
        document.body.setAttribute('data-document-type', docType);
        
        // Generate QR code
        const billUrl = `${window.location.origin}/bill.html?billId=${billId}`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(billUrl)}`;

        // Set QR code image source
        const qrImg = document.querySelector('.col-md-2.text-center img');
        if (qrImg) {
            qrImg.src = qrUrl;
            qrImg.classList.remove('d-none');
        }
        
        // Show QR text
        const qrText = document.querySelector('.qr-text');
        if (qrText) {
            qrText.classList.remove('d-none');
        }
                    
        // Display Bill To Information - Using JSON config
        await displayBillToInfo(data, docTypeKey);
        
        // Display Document Details - Using JSON config
        await displayDocumentDetails(data, docTypeKey);
        
        // Display Ship To if exists
        if (data.shipTo && data.saveShipTo !== false) {
            document.getElementById('shipToSection').style.display = 'block';
            document.getElementById('shipToAddress').textContent = data.shipTo;
        }
        
        // Display Transportation if exists
        if ((data.transportName || data.vehicleNumber || data.deliveryDate || data.deliveryLocation) && data.saveTransportation !== false) {
            document.getElementById('transportationSection').style.display = 'block';
            displayTransportationInfo(data);
        }
        
        // Display Items
        displayItems(data.items || []);
        
        // Display Totals with new layout
        displayTotals(data);
        
        // Display Additional Info if exists
        if (data.field5) {
            document.getElementById('additionalInfoSection').style.display = 'block';
            document.getElementById('additionalInfo').textContent = data.field5;
        }
        
        // Equalize column heights after content is loaded
        setTimeout(equalizeColumnHeights, 100);
        
    } catch (error) {
        console.error('Error in displayBillData:', error);
        showStatus('Error loading document data', 'danger');
    }
}

// Load and apply document type settings from JSON
async function loadAndApplyDocumentTypeSettings(docTypeKey) {
    try {
        const config = await loadDocumentTypesConfig();
        const docConfig = config.documentTypes[docTypeKey];

        if (!docConfig) {
            console.warn('No document type config found for:', docTypeKey);
            // Use default values
            setDefaultDocumentTypeLabels();
            return;
        }

        // Apply document type labels from JSON config
        applyDocumentTypeLabels(docConfig);

        // BANK DETAILS HANDLING
        if (docConfig.showBankDetails === true) {
            document.getElementById('bankDetailsSection').style.display = 'block';
            displayBankDetailsFromConfig(config.bank_details);
        } else {
            document.getElementById('bankDetailsSection').style.display = 'none';
        }

        // Show/hide sections based on config
        toggleSectionsBasedOnConfig(docConfig);

    } catch (err) {
        console.error('Error applying document type config:', err);
        setDefaultDocumentTypeLabels();
    }
}

// Apply document type labels from config
function applyDocumentTypeLabels(docConfig) {
    // Set document title if not already set from data
    if (docConfig.name && !document.getElementById('documentTitle').textContent) {
        document.getElementById('documentTitle').textContent = docConfig.name;
    }
    
    // Set section titles from config
    if (docConfig.billToTitle) {
        document.getElementById('billToSectionTitle').textContent = docConfig.billToTitle;
    }
    
    if (docConfig.invoiceDetailsTitle) {
        document.getElementById('documentDetailsTitle').textContent = docConfig.invoiceDetailsTitle;
    }
}

// Set default labels if config is not found
function setDefaultDocumentTypeLabels() {
    document.getElementById('billToSectionTitle').textContent = 'Bill To Information';
    document.getElementById('documentDetailsTitle').textContent = 'Document Details';
}

// Toggle sections visibility based on config
function toggleSectionsBasedOnConfig(docConfig) {
    // Ship To section
    if (docConfig.showShipTo === false) {
        document.getElementById('shipToSection').style.display = 'none';
    }
    
    // Transportation section
    if (docConfig.showTransportation === false) {
        document.getElementById('transportationSection').style.display = 'none';
    }
    
    // Additional Info section
    if (docConfig.showAdditionalInfo === false) {
        document.getElementById('additionalInfoSection').style.display = 'none';
    }
}

// Display Bill To Information - Using JSON config labels
async function displayBillToInfo(data, docTypeKey) {
    try {
        const config = await loadDocumentTypesConfig();
        const docConfig = config.documentTypes[docTypeKey] || {};
        
        const billToInfo = document.getElementById('billToInfo');
        let html = '';
        
        if (data.clientName) {
            const label = docConfig.clientNameLabel || 'Client Name';
            html += `<div class="info-row">
                <div class="info-label">${label}: ${data.clientName}</div>
            </div>`;
        }
        
        // Show GST only if enabled in config
        if (data.clientGST && docConfig.showClientGST !== false) {
            html += `<div class="info-row">
                <div class="info-label">GSTIN: ${data.clientGST}</div>
            </div>`;
        }
        
        // Show address only if enabled in config
        if (data.clientAddress && docConfig.showClientAddress !== false) {
            html += `<div class="info-row">
                <div class="info-label">Address: ${data.clientAddress}</div>
            </div>`;
        }
        
        // Show state only if enabled in config
        if (data.clientState && docConfig.showClientState !== false) {
            html += `<div class="info-row">
                <div class="info-label">State: ${data.clientState}</div>
            </div>`;
        }
        
        billToInfo.innerHTML = html;
    } catch (error) {
        console.error('Error in displayBillToInfo:', error);
        // Fallback to original method
        const billToInfo = document.getElementById('billToInfo');
        let html = '';
        
        if (data.clientName) {
            html += `<div class="info-row">
                <div class="info-label">${data.clientNameLabel || 'Client Name'}: ${data.clientName}</div>
            </div>`;
        }
        
        if (data.clientGST) {
            html += `<div class="info-row">
                <div class="info-label">GSTIN: ${data.clientGST}</div>
            </div>`;
        }
        
        if (data.clientAddress) {
            html += `<div class="info-row">
                <div class="info-label">Address: ${data.clientAddress}</div>
            </div>`;
        }
        
        if (data.clientState) {
            html += `<div class="info-row">
                <div class="info-label">State: ${data.clientState}</div>
            </div>`;
        }
        
        billToInfo.innerHTML = html;
    }
}

// Display Document Details - Using JSON config labels
async function displayDocumentDetails(data, docTypeKey) {
    try {
        const config = await loadDocumentTypesConfig();
        const docConfig = config.documentTypes[docTypeKey] || {};
        
        const documentDetails = document.getElementById('documentDetailsInfo');
        let html = '';
        
        if (data.invoiceNo && docConfig.showInvoiceNo !== false) {
            const label = docConfig.documentNumberLabel || 'Document No';
            html += `<div class="info-row">
                <div class="info-label">${label}: ${data.invoiceNo}</div>
            </div>`;
        }
        
        if (data.invoiceDate && docConfig.showInvoiceDate !== false) {
            const label = docConfig.documentDateLabel || 'Date';
            const invoiceDate = data.invoiceDateFormatted || formatDate(data.invoiceDate);
            html += `<div class="info-row">
                <div class="info-label">${label}: ${invoiceDate}</div>
            </div>`;
        }
        
        if (data.placeOfSupply && docConfig.showPlaceOfSupply !== false) {
            html += `<div class="info-row">
                <div class="info-label">Place of Supply: ${data.placeOfSupply}</div>
            </div>`;
        }
        
        documentDetails.innerHTML = html;
    } catch (error) {
        console.error('Error in displayDocumentDetails:', error);
        // Fallback to original method
        const documentDetails = document.getElementById('documentDetailsInfo');
        let html = '';
        
        if (data.invoiceNo) {
            html += `<div class="info-row">
                <div class="info-label">${data.documentNumberLabel || 'Document No'}: ${data.invoiceNo}</div>
            </div>`;
        }
        
        if (data.invoiceDate) {
            const invoiceDate = data.invoiceDateFormatted || formatDate(data.invoiceDate);
            html += `<div class="info-row">
                <div class="info-label">${data.documentDateLabel || 'Date'}: ${invoiceDate}</div>
            </div>`;
        }
        
        if (data.placeOfSupply) {
            html += `<div class="info-row">
                <div class="info-label">Place of Supply: ${data.placeOfSupply}</div>
            </div>`;
        }
        
        documentDetails.innerHTML = html;
    }
}

// Handle different document types
function handleDocumentType(docType) {
    const termsCol = document.querySelector('.terms-section');
    const receivedByCol = document.querySelector('.received-by-section');
    const deliveredByCol = document.querySelector('.delivered-by-section');
    const authorizedCol = document.querySelector('.authorized-col');
    const footerSection = document.querySelector('.footer-section');
    const companyHeader = document.querySelector('.company-header');
    
    // Check for Delivery Challan
    if (docType.includes('delivery challan')) {
        // Remove d-none from Received By and Delivered By columns
        if (receivedByCol) {
            receivedByCol.classList.remove('d-none');
        }
        if (deliveredByCol) {
            deliveredByCol.classList.remove('d-none');
        }
        
        // Change col-8 to col-3 for Terms & Conditions
        if (termsCol) {
            termsCol.classList.remove('col-8');
            termsCol.classList.add('col-3');
        }
        
        // Ensure authorized column is col-3
        if (authorizedCol) {
            authorizedCol.classList.remove('col-3');
            authorizedCol.classList.add('col-3');
        }
    } else {
        // For non-Delivery Challan documents
        // Ensure Terms & Conditions is col-8
        if (termsCol) {
            termsCol.classList.remove('col-3');
            termsCol.classList.add('col-8');
        }
        
        // Ensure authorized column is col-3
        if (authorizedCol) {
            authorizedCol.classList.remove('col-3');
            authorizedCol.classList.add('col-3');
        }
        
        // Keep Received By and Delivered By hidden
        if (receivedByCol) {
            receivedByCol.classList.add('d-none');
        }
        if (deliveredByCol) {
            deliveredByCol.classList.add('d-none');
        }
    }
    
    // Check for Cash Memo
    if (docType.includes('cash memo')) {
        // Hide footer section and company header
        if (footerSection) {
            footerSection.style.display = 'none';
        }
        if (companyHeader) {
            companyHeader.style.display = 'none';
        }
    } else {
        // Show footer section and company header for non-Cash Memo
        if (footerSection) {
            footerSection.style.display = '';
        }
        if (companyHeader) {
            companyHeader.style.display = '';
        }
    }
}

// Equalize heights of Bill To and Document Details columns
function equalizeColumnHeights() {
    const billToInfo = document.getElementById('billToInfo');
    const documentDetailsInfo = document.getElementById('documentDetailsInfo');
    
    if (billToInfo && documentDetailsInfo) {
        const billToHeight = billToInfo.offsetHeight;
        const documentDetailsHeight = documentDetailsInfo.offsetHeight;
        const maxHeight = Math.max(billToHeight, documentDetailsHeight);
        
        billToInfo.style.minHeight = maxHeight + 'px';
        documentDetailsInfo.style.minHeight = maxHeight + 'px';
    }
}

// Display Transportation Information - Fixed for print
function displayTransportationInfo(data) {
    const transportationInfo = document.getElementById('transportationInfo');
    let html = '';
    
    if (data.transportName) {
        html += `<div class="col-md-3">
            <div class="info-row">
                <div class="info-label">Transport: ${data.transportName}</div>
            </div>
        </div>`;
    }
    
    if (data.vehicleNumber) {
        html += `<div class="col-md-3">
            <div class="info-row">
                <div class="info-label">Vehicle No: ${data.vehicleNumber}</div>
            </div>
        </div>`;
    }
    
    if (data.deliveryDate) {
        const deliveryDate = data.deliveryDateFormatted || formatDate(data.deliveryDate);
        html += `<div class="col-md-3">
            <div class="info-row">
                <div class="info-label">Del. Date: ${deliveryDate}</div>
            </div>
        </div>`;
    }
    
    if (data.deliveryLocation) {
        html += `<div class="col-md-3">
            <div class="info-row">
                <div class="info-label">Del. Location: ${data.deliveryLocation}</div>
            </div>
        </div>`;
    }
    
    transportationInfo.innerHTML = html;
}

// Display Items
function displayItems(items) {
    const tbody = document.getElementById('itemsTableBody');
    let html = '';
    let subtotal = 0;
    
    items.forEach((item, index) => {
        const amount = (item.quantity || 0) * (item.price || 0);
        subtotal += amount;
        
        html += `<tr>
            <td>${index + 1}</td>
            <td class="text-start">${item.name || ''}</td>
            <td>${item.hsn || ''}</td>
            <td>${formatNumber(item.quantity || 0)}</td>
            <td>${item.unit || ''}</td>
            <td class="text-right">${formatCurrency(item.price || 0)}</td>
            <td class="text-right">${formatCurrency(amount)}</td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
    document.getElementById('subtotalAmount').textContent = formatNumber(subtotal);
}

// Display Totals with CGST/SGST above tax
function displayTotals(data) {
    const subtotal = data.subtotal || 0;
    const discountPercent = data.discountPercent || 0;
    const discountAmount = data.discountAmount || 0;
    const totalAfterDiscount = data.totalAfterDiscount || subtotal;
    const taxRate = data.taxRate || 0;
    const taxAmount = data.taxAmount || 0;
    const grandTotal = data.grandTotal || totalAfterDiscount + taxAmount;
    
    // Get tax breakdown data
    const isIntraState = data.isIntraState !== false;
    const cgstRate = data.cgstRate || 0;
    const sgstRate = data.sgstRate || 0;
    const igstRate = data.igstRate || 0;
    const cgstAmount = data.cgstAmount || 0;
    const sgstAmount = data.sgstAmount || 0;
    const igstAmount = data.igstAmount || 0;
    
    // Show discount if exists
    if (discountPercent > 0) {
        document.getElementById('discountRow').style.display = 'block';
        document.getElementById('discountPercent').textContent = formatNumber(discountPercent);
        document.getElementById('discountAmount').textContent = formatNumber(discountAmount);
        document.getElementById('totalAfterDiscount').textContent = formatNumber(totalAfterDiscount);
    }
    
    // Update tax and grand total
    document.getElementById('taxRate').textContent = formatNumber(taxRate);
    document.getElementById('taxAmount').textContent = formatNumber(taxAmount);
    document.getElementById('grandTotal').textContent = formatNumber(grandTotal);
    
    // Update subtotal
    document.getElementById('subtotalAmount').textContent = formatNumber(subtotal);
    
    // Display tax breakdown with new order
    const taxBreakdownDetails = document.getElementById('taxBreakdownDetails');
    let taxHtml = '';
    
    if (isIntraState && (cgstRate > 0 || cgstAmount > 0)) {
        // Intra-state: Show CGST and SGST
        taxHtml += `
            <div class="amount-row row">
                <div class="col-6 amount-label">CGST (${formatNumber(cgstRate)}%):</div>
                <div class="col-6 amount-value">₹ ${formatNumber(cgstAmount)}</div>
            </div>
            <div class="amount-row row">
                <div class="col-6 amount-label">SGST (${formatNumber(sgstRate)}%):</div>
                <div class="col-6 amount-value">₹ ${formatNumber(sgstAmount)}</div>
            </div>
        `;
    } else if (!isIntraState && (igstRate > 0 || igstAmount > 0)) {
        // Inter-state: Show IGST
        taxHtml += `
            <div class="amount-row row">
                <div class="col-6 amount-label">IGST (${formatNumber(igstRate)}%):</div>
                <div class="col-6 amount-value">₹ ${formatNumber(igstAmount)}</div>
            </div>
        `;
    }
    
    taxBreakdownDetails.innerHTML = taxHtml;
    
    // Add Amount in Words after Grand Total
    const amountInWords = convertToWords(grandTotal);
    const grandTotalRow = document.querySelector('.grand-total');
    
    // Create Amount in Words row
    const amountInWordsRow = document.createElement('div');
    amountInWordsRow.className = 'amount-row row';
    amountInWordsRow.style.fontSize = '10px';
    amountInWordsRow.style.marginTop = '2px';
    amountInWordsRow.innerHTML = `
        <div class="col-6 amount-label">Amount in Words:</div>
        <div class="col-6 amount-value" style="text-align: right; font-style: italic;">${amountInWords} only</div>
    `;
    
    // Insert after the grand total row
    grandTotalRow.parentNode.insertBefore(amountInWordsRow, grandTotalRow.nextSibling);
}

// Function to convert number to words
function convertToWords(num) {
    const a = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '];
    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
    
    // Round to 2 decimal places and split into rupees and paise
    const n = parseFloat(num).toFixed(2);
    const parts = n.toString().split('.');
    let rupees = parseInt(parts[0]);
    let paise = parts[1] ? parseInt(parts[1]) : 0;
    
    if (rupees === 0 && paise === 0) {
        return 'Zero Rupees';
    }
    
    let words = '';
    
    // Convert rupees
    if (rupees > 0) {
        if (rupees >= 10000000) {
            words += convertToCrore(rupees) + ' Crore ';
            rupees %= 10000000;
        }
        if (rupees >= 100000) {
            words += convertToLakh(rupees) + ' Lakh ';
            rupees %= 100000;
        }
        if (rupees >= 1000) {
            words += convertToThousand(rupees) + ' Thousand ';
            rupees %= 1000;
        }
        if (rupees >= 100) {
            words += convertToHundred(rupees) + ' Hundred ';
            rupees %= 100;
        }
        if (rupees > 0) {
            if (rupees < 20) {
                words += a[rupees];
            } else {
                words += b[Math.floor(rupees / 10)] + ' ' + a[rupees % 10];
            }
        }
        words += 'Rupees';
    }
    
    // Convert paise
    if (paise > 0) {
        if (words.length > 0) {
            words += ' and ';
        }
        if (paise < 20) {
            words += a[paise];
        } else {
            words += b[Math.floor(paise / 10)] + ' ' + a[paise % 10];
        }
        words += 'Paise';
    }
    
    return words.trim();
}

// Helper functions for number conversion
function convertToCrore(num) {
    const crores = Math.floor(num / 10000000);
    return convertToWords(crores);
}

function convertToLakh(num) {
    const lakhs = Math.floor(num / 100000);
    const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
    
    let words = '';
    const lakhsPart = lakhs % 100;
    if (lakhsPart > 0) {
        if (lakhsPart < 20) {
            words = a[lakhsPart];
        } else {
            words = b[Math.floor(lakhsPart / 10)] + ' ' + a[lakhsPart % 10];
        }
    }
    return words;
}

function convertToThousand(num) {
    const thousands = Math.floor(num / 1000);
    const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
    
    let words = '';
    const thousandsPart = thousands % 100;
    if (thousandsPart > 0) {
        if (thousandsPart < 20) {
            words = a[thousandsPart];
        } else {
            words = b[Math.floor(thousandsPart / 10)] + ' ' + a[thousandsPart % 10];
        }
    }
    return words;
}

function convertToHundred(num) {
    const hundreds = Math.floor(num / 100);
    const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
    return a[hundreds];
}

// Display Bank Details - Fixed for print
function displayBankDetailsFromConfig(bank) {
    const bankDetails = document.getElementById('bankDetailsInfo');
    let html = '';

    if (bank.bank_name) {
        html += `
        <div class="col-md-3">
            <div class="info-row">
                <div class="info-label">Bank: ${bank.bank_name}</div>
            </div>
        </div>`;
    }

    if (bank.account_number) {
        html += `
        <div class="col-md-3">
            <div class="info-row">
                <div class="info-label">A/C No: ${bank.account_number}</div>
            </div>
        </div>`;
    }

    if (bank["IFSC Code"]) {
        html += `
        <div class="col-md-3">
            <div class="info-row">
                <div class="info-label">IFSC: ${bank["IFSC Code"]}</div>
            </div>
        </div>`;
    }

    if (bank["Account Holder Name"]) {
        html += `
        <div class="col-md-3">
            <div class="info-row">
                <div class="info-label">A/C Holder: ${bank["Account Holder Name"]}</div>
            </div>
        </div>`;
    }

    bankDetails.innerHTML = html;
}

// Utility Functions
function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB');
    } catch (e) {
        return dateString;
    }
}

function formatNumber(num) {
    return parseFloat(num).toFixed(2);
}

function formatCurrency(num) {
    return parseFloat(num).toFixed(2);
}

function showStatus(message, type = 'info') {
    // Create a temporary status message
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1050;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// Event Listeners
document.getElementById('printBtn').addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Force DOM update before print
    setTimeout(() => {
        window.print();
    }, 100);
});

document.getElementById('backBtn').addEventListener('click', function() {
    window.history.back();
});

// Add keyboard shortcut for printing (Ctrl+P)
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        setTimeout(() => {
            window.print();
        }, 100);
    }
});

// Trigger equal height adjustment on window resize
window.addEventListener('resize', equalizeColumnHeights);

// PDF Export functionality
document.getElementById('pdfBtn').addEventListener('click', async function () {
    const { jsPDF } = window.jspdf;
    const invoice = document.querySelector('.a4-container');

    // ADD TEMP PDF CLASS
    invoice.classList.add('pdf-mode');

    const canvas = await html2canvas(invoice, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        scrollY: -window.scrollY
    });

    const imgData = canvas.toDataURL('image/jpeg', 1.0);

    const pdf = new jsPDF('p', 'mm', 'a4');

    const pageWidth = 210;
    const pageHeight = 297;

    const imgWidth = pageWidth - 10; // small margin
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let position = 5; // TOP SAFE MARGIN
    let heightLeft = imgHeight;

    pdf.addImage(imgData, 'JPEG', 5, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
        pdf.addPage();
        position = 5;
        pdf.addImage(imgData, 'JPEG', 5, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
    }

    const fileName =
        (document.getElementById('documentTitle')?.innerText || 'Invoice')
            .replace(/\s+/g, '_') + '.pdf';

    pdf.save(fileName);

    // REMOVE TEMP CLASS
    invoice.classList.remove('pdf-mode');
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>