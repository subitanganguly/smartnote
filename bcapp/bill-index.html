<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Barman Construction</title>
  <link rel="icon" type="image/png" href="img/tab-logo.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style/style.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="js/firebaseconfig.js"></script>
  <script src="js/all.js"></script>
  <style>
    /* Custom styles for hiding fields */
    .field-hidden {
      display: none !important;
    }
    
    .form-control:disabled {
      background-color: #f8f9fa;
      cursor: not-allowed;
    }
    
    .document-section {
      transition: all 0.3s ease;
    }
  </style>
</head>
<body>

<!-- Navbar will load here -->
<div id="nav-placeholder"></div>

<!-- Main Content -->
<div class="content p-3">
  <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-1 top-h">
            <div>
                <h4 class="mb-1">Generate Document</h4>
            </div>
        </div>
<!-- Main Form -->
        <div class="row">
            <div class="col-12">
                <div class="mb-2">
                    <div class="card-body">
                        <form id="invoiceForm">
                            <!-- Document Type Selection -->
                            <div class="document-type-select mb-2">
                                <label for="documentType" class="form-label fw-bold">Document Type <span class="text-danger">*</span></label>
                                <select class="form-select" id="documentType" required>
                                    <option value="tax-invoice" selected>Tax Invoice</option>
                                    <option value="delivery-challan">Delivery Challan</option>
                                    <option value="quotation">Quotation</option>
                                    <option value="proforma-invoice">Proforma Invoice</option>
                                    <option value="purchase-invoice">Purchase Invoice</option>
                                    <option value="cash-memo">Cash Memo</option>
                                </select>
                            </div>

                            <!-- Bill To Information -->
                            <div class="document-section mb-2">
                                <h6 class="border-bottom p-1 bg-secondary text-light rounded bill-to-header">
                                    <i class="fas fa-user-tie me-2"></i><span id="billToTitle">Bill To Information</span>
                                </h6>
                                <div class="row g-3 mb-2">
                                    <div class="col-md-3">
                                        <label for="clientName" class="form-label fw-bold"><span id="clientNameLabel">Client Name</span> <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="clientName" value="" placeholder="Enter name" autocomplete="off">
                                    </div>
                                    <div class="col-md-3" id="clientGSTField">
                                        <label for="clientGST"  class="form-label fw-bold">Client GSTIN</label>
                                        <input type="text" class="form-control" id="clientGST" value="" placeholder="Client GSTIN">
                                    </div>
                                    <div class="col-md-4" id="clientAddressField">
                                        <label for="clientAddress" class="form-label fw-bold">Client Address</label>
                                        <textarea class="form-control" id="clientAddress" rows="1" placeholder="Client Address"></textarea>
                                    </div>
                                    <div class="col-md-2" id="clientStateField">
                                        <label for="clientState" class="form-label fw-bold">Client State</label>
                                        <input type="text" class="form-control" id="clientState" value="West Bengal">
                                    </div>
                                </div>
                            </div>

                            <!-- Ship To Information (Separate Section) -->
                            <div class="document-section mb-2 d-none" id="shipToSection">
                                <h6 class="border-bottom p-1 bg-secondary text-light rounded">
                                    <i class="fas fa-shipping-fast me-2"></i>Ship To Information
                                </h6>
                                <div class="row g-3 mb-2 ">
                                    <div class="col-md-12">
                                        <label for="shipTo" class="form-label">Shipping Address</label>
                                        <textarea class="form-control" id="shipTo" rows="1" placeholder="Enter shipping address"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Document Details -->
                            <div class="document-section mb-2">
                                <h6 class="border-bottom p-1 bg-secondary text-light rounded invoice-details-header">
                                    <i class="fas fa-file-invoice me-2"></i><span id="invoiceDetailsTitle">Invoice Details</span>
                                </h6>
                                <div class="row g-3 mb-2 ">
                                    <div class="col-md-4" id="invoiceNoField">
                                        <label for="invoiceNo" class="form-label fw-bold"><span id="documentNumberLabel">Document Number</span></label>
                                        <input type="text" class="form-control" id="invoiceNo" value="">
                                        <small class="text-muted" id="lastInvoiceNumber">Last document number: Loading...</small>
                                    </div>
                                    <div class="col-md-4" id="invoiceDateField">
                                        <label for="invoiceDate" class="form-label fw-bold"><span id="documentDateLabel">Document Date</span></label>
                                        <input type="date" class="form-control" id="invoiceDate" value="" placeholder="Document Date">
                                    </div>
                                    <div class="col-md-4" id="placeOfSupplyField">
                                        <label for="placeOfSupply" class="form-label fw-bold">Place of Supply</label>
                                        <input type="text" class="form-control" id="placeOfSupply" value="">
                                    </div>
                                </div>
                            </div>

                            <!-- Transportation Details -->
                            <div class="document-section mb-2 d-none" id="transportationSection">
                                <h6 class="border-bottom p-1 bg-secondary text-light rounded">
                                    <i class="fas fa-truck me-2"></i>Transportation Details
                                </h6>
                                <div class="transport-section ">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label for="transportName" class="form-label">Transport Name</label>
                                            <input type="text" class="form-control" id="transportName" placeholder="Enter transport company name">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="vehicleNumber" class="form-label">Vehicle Number</label>
                                            <input type="text" class="form-control" id="vehicleNumber" placeholder="Enter vehicle number">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="deliveryDate" class="form-label">Delivery Date</label>
                                            <input type="date" class="form-control" id="deliveryDate">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="deliveryLocation" class="form-label">Delivery Location</label>
                                            <input type="text" class="form-control" id="deliveryLocation" placeholder="Enter delivery location">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tax Rates Section -->
                            <div class="document-section mb-2 d-none" id="taxRatesSection">
                                <h6 class="border-bottom p-1 bg-secondary text-light rounded">
                                    <i class="fas fa-percentage me-2"></i>Tax Rates
                                </h6>
                                <div class="row g-3 mb-2 ">
                                    <!-- CGST Rate (Only for intra-state - GST starts with 19) -->
                                    <div class="col-md-3" id="cgstRateField">
                                        <label for="cgstRate" class="form-label fw-bold">CGST Rate (%)</label>
                                        <input type="number" class="form-control" id="cgstRate" step="0.01" min="0" max="100" value="9">
                                    </div>
                                    <!-- SGST Rate (Only for intra-state - GST starts with 19) -->
                                    <div class="col-md-3" id="sgstRateField">
                                        <label for="sgstRate" class="form-label fw-bold">SGST Rate (%)</label>
                                        <input type="number" class="form-control" id="sgstRate" step="0.01" min="0" max="100" value="9">
                                    </div>
                                    <!-- IGST Rate (Only for inter-state - GST doesn't start with 19) -->
                                    <div class="col-md-3 d-none" id="igstRateField">
                                        <label for="igstRate" class="form-label fw-bold">IGST Rate (%)</label>
                                        <input type="number" class="form-control" id="igstRate" step="0.01" min="0" max="100" value="18">
                                    </div>
                                    <!-- Total Tax Rate -->
                                    <div class="col-md-3">
                                        <label for="totalTaxRate" class="form-label fw-bold">Total Tax Rate (%)</label>
                                        <input type="number" class="form-control" id="totalTaxRate" step="0.01" min="0" max="100" readonly value="18">
                                    </div>
                                </div>
                            </div>

                            <!-- Document Items -->
                            <div class="document-section mb-2">
                                <h6 class="border-bottom p-1 bg-secondary text-light rounded">
                                    <i class="fas fa-boxes me-2"></i>Document Items
                                </h6>
                                <div class="">
                                   <button type="button" id="addItemBtn" class="btn btn-primary mb-1 btn-sm">
                                        <i class="fas fa-plus me-1"></i> Add Item
                                    </button>
                                    <table class="table table-bordered table-hover" id="itemsTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Item Name</th>
                                                <th>HSN/SAC</th>
                                                <th>Quantity</th>
                                                <th>Unit</th>
                                                <th>Price/Unit (Rs)</th>
                                                <th>Amount (Rs)</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="itemsTableBody">
                                            <!-- Items will be added here dynamically -->
                                        </tbody>
                                        <tfoot id="itemsTableFooter">
                                            <!-- Total row will be added here dynamically -->
                                        </tfoot>
                                    </table>
                                   
                                </div>
                            </div>

                            <!-- Additional Info Section -->
                            <div class="document-section mb-2 d-none" id="additionalInfoSection">
                                <h6 class="border-bottom p-1 bg-secondary text-light rounded">
                                    <i class="fas fa-info-circle me-2"></i>Additional Information
                                </h6>
                                <div class="row g-3 ">
                                    <div class="col-md-12">
                                        <label for="field5" class="form-label">Additional Information</label>
                                        <textarea class="form-control" id="field5" rows="2" placeholder="Enter any additional information"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Bank Details -->
                            <div class="document-section mb-2 d-none" id="bankDetailsSection">
                                <h6 class="border-bottom p-1 bg-secondary text-light rounded">
                                    <i class="fas fa-university me-2"></i>Bank Details
                                </h6>
                                <div class="row g-3 mb-3 ">
                                    <div class="col-md-3">
                                        <label for="bankName" class="form-label fw-bold">Bank Name</label>
                                        <input type="text" class="form-control" id="bankName" value="Axis Bank, Jalpaiguri (west Bengal)">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="accountNo" class="form-label fw-bold">Account Number</label>
                                        <input type="text" class="form-control" id="accountNo" value="919020059583357">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="ifscCode" class="form-label fw-bold">IFSC Code</label>
                                        <input type="text" class="form-control" id="ifscCode" value="UTIB0000442">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="accountHolder" class="form-label fw-bold">Account Holder Name</label>
                                        <input type="text" class="form-control" id="accountHolder" value="Barman Construction">
                                    </div>
                                </div>
                            </div>

                            <!-- Form Information -->
                            <div class="alert alert-info mb-2">
                                <strong>Note:</strong> <span id="documentTypeInfo">For Tax Invoice: All fields including tax rates are required. GST details are mandatory.</span>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
                                <button type="button" id="resetBtn" class="btn btn-warning flex-fill">
                                    <i class="fas fa-redo me-1"></i> Reset Form
                                </button>
                                <button type="submit" id="generateBtn" class="btn btn-success flex-fill">
                                    <i class="fas fa-file-export me-1"></i> Generate Document
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="alert alert-dismissible fade" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 1050; display: none;">
            <span id="statusText"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

</div>

<script>
  // Global variable for document types configuration
  let documentTypesConfig = {};

  // Load document types configuration from JSON file
  async function loadDocumentTypesConfig() {
    try {
      const response = await fetch('js/document-types.json');
      if (!response.ok) {
        throw new Error('Failed to load document types configuration');
      }
      const config = await response.json();
      documentTypesConfig = config.documentTypes;
      console.log('Document types configuration loaded:', documentTypesConfig);
    } catch (error) {
      console.error('Error loading document types config:', error);
    }
  }

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  // Check if GSTIN is intra-state (starts with 19 for West Bengal)
  function isIntraStateGST(gstin) {
    if (!gstin || gstin.length < 2) return true; // Default to intra-state
    return gstin.startsWith('19');
  }

  // Update tax fields based on GSTIN
  function updateTaxFieldsBasedOnGST() {
    const gstin = document.getElementById('clientGST').value.trim();
    const isIntraState = isIntraStateGST(gstin);
    
    const cgstField = document.getElementById('cgstRateField');
    const sgstField = document.getElementById('sgstRateField');
    const igstField = document.getElementById('igstRateField');
    const cgstInput = document.getElementById('cgstRate');
    const sgstInput = document.getElementById('sgstRate');
    const igstInput = document.getElementById('igstRate');
    const totalTaxInput = document.getElementById('totalTaxRate');
    
    if (isIntraState) {
      // Intra-state: Show CGST + SGST, hide IGST
      cgstField.style.display = 'block';
      sgstField.style.display = 'block';
      igstField.classList.add('d-none');
      
      // Calculate total from CGST + SGST
      const cgstRate = parseFloat(cgstInput.value) || 0;
      const sgstRate = parseFloat(sgstInput.value) || 0;
      totalTaxInput.value = (cgstRate + sgstRate).toFixed(2);
    } else {
      // Inter-state: Show IGST, hide CGST + SGST
      cgstField.style.display = 'none';
      sgstField.style.display = 'none';
      igstField.classList.remove('d-none');
      
      // Total tax is IGST rate
      const igstRate = parseFloat(igstInput.value) || 0;
      totalTaxInput.value = igstRate.toFixed(2);
    }
    
    // Recalculate totals after tax update
    calculateAndDisplayTotals();
  }

  // Check authentication status
  firebase.auth().onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "login.html";
    } else {
      // User is authenticated
      checkUserPermissions(user.uid);
      // Load last invoice number
      loadLastInvoiceNumber();
    }
  });

  // Optional: Check user permissions based on your rules
  async function checkUserPermissions(userId) {
    try {
      const userRef = firebase.database().ref(`users/${userId}`);
      const snapshot = await userRef.once('value');
      const userData = snapshot.val();
      
      if (userData && userData.role) {
        localStorage.setItem('userRole', userData.role);
        console.log(`User role: ${userData.role}`);
      }
    } catch (error) {
      console.error('Error fetching user data:', error);
    }
  }

  // Function to check if invoice number already exists
  async function checkInvoiceNumberExists(invoiceNumber) {
    try {
      const billsRef = firebase.database().ref('bill');
      const snapshot = await billsRef.orderByChild('invoiceNo').equalTo(invoiceNumber).once('value');
      return snapshot.exists();
    } catch (error) {
      console.error('Error checking invoice number:', error);
      return false;
    }
  }

  // Function to get the last document number based on document type
  async function loadLastInvoiceNumber() {
    try {
      const documentType = document.getElementById('documentType').value;
      const documentConfig = documentTypesConfig[documentType];
      
      if (!documentConfig) {
        document.getElementById('lastInvoiceNumber').textContent = 'Error: Document type not found';
        return;
      }
      
      // Get current year
      const currentYear = new Date().getFullYear();
      
      // Define prefix mapping for different document types
      const typePrefixes = {
        'tax-invoice': 'TAX',
      'delivery-challan': 'DELIVERY',
      'quotation': 'QTN',
      'proforma-invoice': 'PROFORMA',
      'purchase-invoice': 'PURCHASE',
      'cash-memo': 'BILL'
      };
      
      const typePrefix = typePrefixes[documentType] || 'DOC';
      
      // Query bills for this document type and current year
      const billsRef = firebase.database().ref('bill');
      const snapshot = await billsRef.orderByChild('documentType').equalTo(documentType).once('value');
      
      let highestSequence = 0;
      
      if (snapshot.exists()) {
        snapshot.forEach(childSnapshot => {
          const billData = childSnapshot.val();
          if (billData.invoiceNo && billData.invoiceNo.includes(`/${currentYear}/`)) {
            // Parse the sequence number from invoice number
            const parts = billData.invoiceNo.split('/');
            if (parts.length >= 4) {
              const sequence = parseInt(parts[3]);
              if (!isNaN(sequence) && sequence > highestSequence) {
                highestSequence = sequence;
              }
            }
          }
        });
      }
      
      // Generate next sequence number
      const nextSequence = highestSequence + 1;
      const paddedSequence = nextSequence.toString().padStart(2, '0');
      
      // Generate the next invoice number
      const nextInvoiceNumber = `BC/${typePrefix}/${currentYear}/${paddedSequence}`;
      
      // Update the display
      document.getElementById('lastInvoiceNumber').textContent = `Last ${documentConfig.name} number: ${highestSequence === 0 ? 'None found' : `BC/${typePrefix}/${currentYear}/${highestSequence.toString().padStart(2, '0')}`}`;
      
      // Auto-fill the invoice number field if it's visible
      const invoiceNoField = document.getElementById('invoiceNo');
      const invoiceNoContainer = document.getElementById('invoiceNoField');
      
      if (!invoiceNoContainer.classList.contains('field-hidden') && 
          !invoiceNoContainer.classList.contains('d-none') &&
          documentConfig.showInvoiceNo) {
        invoiceNoField.value = nextInvoiceNumber;
      }
      
      return nextInvoiceNumber;
      
    } catch (error) {
      console.error('Error loading last invoice number:', error);
      document.getElementById('lastInvoiceNumber').textContent = 'Error loading last document number';
      return null;
    }
  }

  // Function to generate document number based on type and year
  function generateDocumentNumber(documentType, year = null, sequence = null) {
    // Get current year if not provided
    if (!year) {
      year = new Date().getFullYear();
    }
    
    // Define prefix mapping for different document types
    const typePrefixes = {
      'tax-invoice': 'TAX',
      'delivery-challan': 'DELIVERY',
      'quotation': 'QTN',
      'proforma-invoice': 'PROFORMA',
      'purchase-invoice': 'PURCHASE',
      'cash-memo': 'BILL'
    };
    
    const typePrefix = typePrefixes[documentType] || 'DOC';
    
    // Generate next sequence number if not provided
    if (sequence === null) {
      // Default to 01 if we can't determine the sequence
      sequence = 1;
    }
    
    const paddedSequence = sequence.toString().padStart(2, '0');
    
    return `BC/${typePrefix}/${year}/${paddedSequence}`;
  }

  // Update field visibility based on configuration
  function updateFieldVisibility(config) {
    // Client GST
    const clientGSTField = document.getElementById('clientGSTField');
    if (config.showClientGST) {
      clientGSTField.classList.remove('field-hidden');
      clientGSTField.classList.remove('d-none');
    } else {
      clientGSTField.classList.add('field-hidden');
    }
    
    // Client Address
    const clientAddressField = document.getElementById('clientAddressField');
    if (config.showClientAddress) {
      clientAddressField.classList.remove('field-hidden');
      clientAddressField.classList.remove('d-none');
    } else {
      clientAddressField.classList.add('field-hidden');
    }
    
    // Client State
    const clientStateField = document.getElementById('clientStateField');
    if (config.showClientState) {
      clientStateField.classList.remove('field-hidden');
      clientStateField.classList.remove('d-none');
    } else {
      clientStateField.classList.add('field-hidden');
    }
    
    // Invoice No
    const invoiceNoField = document.getElementById('invoiceNoField');
    if (config.showInvoiceNo) {
      invoiceNoField.classList.remove('field-hidden');
      invoiceNoField.classList.remove('d-none');
    } else {
      invoiceNoField.classList.add('field-hidden');
    }
    
    // Invoice Date
    const invoiceDateField = document.getElementById('invoiceDateField');
    if (config.showInvoiceDate) {
      invoiceDateField.classList.remove('field-hidden');
      invoiceDateField.classList.remove('d-none');
    } else {
      invoiceDateField.classList.add('field-hidden');
    }
    
    // Place of Supply
    const placeOfSupplyField = document.getElementById('placeOfSupplyField');
    if (config.showPlaceOfSupply) {
      placeOfSupplyField.classList.remove('field-hidden');
      placeOfSupplyField.classList.remove('d-none');
    } else {
      placeOfSupplyField.classList.add('field-hidden');
    }
    
    // Last invoice number text
    const lastInvoiceText = document.getElementById('lastInvoiceNumber');
    if (config.showInvoiceNo) {
      lastInvoiceText.style.display = 'block';
    } else {
      lastInvoiceText.style.display = 'none';
    }
  }

  // Update section visibility based on configuration
  function updateSectionVisibility(config) {
    // Ship To section
    const shipToSection = document.getElementById('shipToSection');
    if (config.showShipTo) {
      shipToSection.classList.remove('d-none');
    } else {
      shipToSection.classList.add('d-none');
    }
    
    // Transportation section
    const transportationSection = document.getElementById('transportationSection');
    if (config.showTransportation) {
      transportationSection.classList.remove('d-none');
    } else {
      transportationSection.classList.add('d-none');
    }
    
    // Tax Rates section
    const taxRatesSection = document.getElementById('taxRatesSection');
    if (config.showTaxRates) {
      taxRatesSection.classList.remove('d-none');
      updateTaxFieldsBasedOnGST();
    } else {
      taxRatesSection.classList.add('d-none');
    }
    
    // Bank Details section
    const bankDetailsSection = document.getElementById('bankDetailsSection');
    if (config.showBankDetails) {
      bankDetailsSection.classList.remove('d-none');
    } else {
      bankDetailsSection.classList.add('d-none');
    }
    
    // Additional Info section
    const additionalInfoSection = document.getElementById('additionalInfoSection');
    if (config.showAdditionalInfo) {
      additionalInfoSection.classList.remove('d-none');
    } else {
      additionalInfoSection.classList.add('d-none');
    }
  }

  // Handle document type change
  function handleDocumentTypeChange() {
    const documentType = document.getElementById('documentType').value;
    const config = documentTypesConfig[documentType];
    
    if (!config) {
      console.error(`No configuration found for document type: ${documentType}`);
      return;
    }
    
    // Update titles and labels
    document.getElementById('billToTitle').textContent = config.billToTitle;
    document.getElementById('invoiceDetailsTitle').textContent = config.invoiceDetailsTitle;
    document.getElementById('clientNameLabel').textContent = config.clientNameLabel;
    document.getElementById('documentNumberLabel').textContent = config.documentNumberLabel;
    document.getElementById('documentDateLabel').textContent = config.documentDateLabel;
    
    // Update placeholder for client name
    document.getElementById('clientName').placeholder = `Enter ${config.clientNameLabel.toLowerCase()}`;
    
    // Update field visibility
    updateFieldVisibility(config);
    
    // Update required fields based on configuration
    updateRequiredFields(config);
    
    // Show/hide sections based on requirements
    updateSectionVisibility(config);

    updatePaymentVisibility(config);

    
    // Update document type info
    updateDocumentTypeInfo(documentType);
    
    // Recalculate totals to reflect tax visibility changes
    calculateAndDisplayTotals();
    
    // Load last document number for this type and auto-fill
    loadLastInvoiceNumber();
  }

  // Update required fields based on configuration
  function updateRequiredFields(config) {
    // Bill To Information
    document.getElementById('clientName').required = config.requireClientName;
    document.getElementById('clientGST').required = config.requireClientGST;
    document.getElementById('clientAddress').required = config.requireClientAddress;
    document.getElementById('clientState').required = config.requireClientState;
    
    // Document Details
    document.getElementById('invoiceNo').required = config.requireInvoiceNo;
    document.getElementById('invoiceDate').required = config.requireInvoiceDate;
    document.getElementById('placeOfSupply').required = config.requirePlaceOfSupply;
    
    // Ship To
    document.getElementById('shipTo').required = config.requireShipTo;
    
    // Transportation
    document.getElementById('transportName').required = config.requireTransportName;
    document.getElementById('vehicleNumber').required = config.requireVehicleNumber;
    document.getElementById('deliveryDate').required = config.requireDeliveryDate;
    document.getElementById('deliveryLocation').required = config.requireDeliveryLocation;
    
    // Tax Rates - only if tax rates section is visible
    const taxRatesSection = document.getElementById('taxRatesSection');
    if (!taxRatesSection.classList.contains('d-none')) {
      const gstin = document.getElementById('clientGST').value.trim();
      const isIntraState = isIntraStateGST(gstin);
      
      if (isIntraState) {
        document.getElementById('cgstRate').required = config.requireCgstRate;
        document.getElementById('sgstRate').required = config.requireSgstRate;
        document.getElementById('igstRate').required = false;
      } else {
        document.getElementById('cgstRate').required = false;
        document.getElementById('sgstRate').required = false;
        document.getElementById('igstRate').required = config.requireIgstRate;
      }
    } else {
      // Hide tax rate fields if section is hidden
      document.getElementById('cgstRate').required = false;
      document.getElementById('sgstRate').required = false;
      document.getElementById('igstRate').required = false;
    }
    
    // Bank Details
    document.getElementById('bankName').required = config.requireBankName;
    document.getElementById('accountNo').required = config.requireAccountNo;
    document.getElementById('ifscCode').required = config.requireIfscCode;
    document.getElementById('accountHolder').required = config.requireAccountHolder;
    
    // Additional Info
    document.getElementById('field5').required = config.requireField5;
  }

  // Update document type info
  function updateDocumentTypeInfo(documentType) {
    const config = documentTypesConfig[documentType];
    if (config) {
      const documentTypeInfo = document.getElementById('documentTypeInfo');
      documentTypeInfo.textContent = config.infoMessage;
    }
  }

  // Update total tax rate
  function updateTotalTaxRate() {
    const gstin = document.getElementById('clientGST').value.trim();
    const isIntraState = isIntraStateGST(gstin);
    const totalTaxInput = document.getElementById('totalTaxRate');
    
    if (isIntraState) {
      // Intra-state: CGST + SGST
      const cgstRate = parseFloat(document.getElementById('cgstRate').value) || 0;
      const sgstRate = parseFloat(document.getElementById('sgstRate').value) || 0;
      totalTaxInput.value = (cgstRate + sgstRate).toFixed(2);
    } else {
      // Inter-state: IGST only
      const igstRate = parseFloat(document.getElementById('igstRate').value) || 0;
      totalTaxInput.value = igstRate.toFixed(2);
    }
    
    // Recalculate totals
    calculateAndDisplayTotals();
  }

  // Calculate and display item amount
  function calculateItemAmount(row) {
    const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
    const price = parseFloat(row.querySelector('.item-price').value) || 0;
    const amount = quantity * price;
    row.querySelector('.item-amount').textContent = amount.toFixed(2);
    
    // Recalculate totals
    calculateAndDisplayTotals();
  }

  // Add item to the table
  function addItem(name = "", hsn = "", quantity = 1, unit = "", price = "0") {
    const tableBody = document.getElementById('itemsTableBody');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="text" class="form-control form-control-sm item-name" value="${name}" required></td>
      <td><input type="text" class="form-control form-control-sm item-hsn" value="${hsn}" required></td>
      <td><input type="number" class="form-control form-control-sm item-quantity" min="0" step="0.01" value="${quantity}" required></td>
      <td><input type="text" class="form-control form-control-sm item-unit" value="${unit}" required></td>
      <td><input type="number" class="form-control form-control-sm item-price" min="0" step="0.01" value="${price}" required></td>
      <td class="item-amount text-end">${(quantity * price).toFixed(2)}</td>
      <td>
        <button type="button" class="btn btn-danger btn-sm remove-item-btn">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tableBody.appendChild(row);
    
    // Add event listeners for quantity and price changes
    const quantityInput = row.querySelector('.item-quantity');
    const priceInput = row.querySelector('.item-price');
    
    quantityInput.addEventListener('input', () => calculateItemAmount(row));
    priceInput.addEventListener('input', () => calculateItemAmount(row));
    
    // Add event listener for the delete button
    row.querySelector('.remove-item-btn').addEventListener('click', function() {
      row.remove();
      calculateAndDisplayTotals();
    });
    
    // Initial calculation
    calculateItemAmount(row);
  }

  // Calculate and display totals with discount
  function calculateAndDisplayTotals() {
    const tableBody = document.getElementById('itemsTableBody');
    const tableFooter = document.getElementById('itemsTableFooter');
    
    // Get current document type configuration
    const documentType = document.getElementById('documentType').value;
    const config = documentTypesConfig[documentType];
    
    // Check if tax calculation should be shown
    const shouldShowTax = config && config.showTaxRates;
    
    // Calculate total amount from all items
    let subtotal = 0;
    const rows = tableBody.querySelectorAll('tr');
    
    rows.forEach(row => {
      const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
      const price = parseFloat(row.querySelector('.item-price').value) || 0;
      subtotal += quantity * price;
    });
    
    // Get discount percentage (if any)
    const discountPercent = parseFloat(document.getElementById('discountPercent')?.value) || 0;
    const discountAmount = subtotal * (discountPercent / 100);
    const totalAfterDiscount = subtotal - discountAmount;
    
    let taxRate = 0;
    let taxAmount = 0;
    let grandTotal = totalAfterDiscount;
    
    // Only calculate tax if tax rates should be shown
    if (shouldShowTax) {
      const gstin = document.getElementById('clientGST').value.trim();
      const isIntraState = isIntraStateGST(gstin);
      
      if (isIntraState) {
        const cgstRate = parseFloat(document.getElementById('cgstRate').value) || 0;
        const sgstRate = parseFloat(document.getElementById('sgstRate').value) || 0;
        taxRate = cgstRate + sgstRate;
      } else {
        taxRate = parseFloat(document.getElementById('igstRate').value) || 0;
      }
      
      // Calculate tax amount
      taxAmount = totalAfterDiscount * (taxRate / 100);
      grandTotal = totalAfterDiscount + taxAmount;
    }


    // ---- PAYMENT LOGIC ----
const paidInput = document.getElementById('paidAmount');
let paidAmount = parseFloat(paidInput?.value) || 0;

let dueAmount = grandTotal - paidAmount;
if (dueAmount < 0) dueAmount = 0;

const dueEl = document.getElementById('dueAmount');
const statusEl = document.getElementById('paymentStatus');

if (dueEl) dueEl.textContent = dueAmount.toFixed(2);

if (statusEl) {
  if (paidAmount >= grandTotal && grandTotal > 0) {
    statusEl.textContent = 'Paid';
    statusEl.className = 'badge bg-success';
  } else {
    statusEl.textContent = 'Due';
    statusEl.className = 'badge bg-danger';
  }
}

    
    // Create or update the totals row
    if (!document.getElementById('totalsRow')) {
      let totalsHtml = `
        <tr id="totalsRow" class="table-info fw-bold">
          <td colspan="4" class="text-end">Subtotal:</td>
          <td colspan="1" class="text-end">₹ <span id="subtotalAmount">${subtotal.toFixed(2)}</span></td>
          <td colspan="2"></td>
        </tr>
        <tr id="discountRow" class="table-warning">
          <td colspan="4" class="text-end">
            <div class="row g-2">
              <div class="col-8">
                <label for="discountPercent" class="form-label mb-0">Discount %:</label>
              </div>
              <div class="col-4">
                <input type="number" class="form-control form-control-sm" id="discountPercent" 
                       min="0" max="100" step="0.01" value="0">
              </div>
            </div>
          </td>
          <td colspan="1" class="text-end">₹ <span id="discountAmount">${discountAmount.toFixed(2)}</span></td>
          <td colspan="2"></td>
        </tr>
        <tr id="afterDiscountRow" class="table-light">
          <td colspan="4" class="text-end">Total After Discount:</td>
          <td colspan="1" class="text-end">₹ <span id="totalAfterDiscount">${totalAfterDiscount.toFixed(2)}</span></td>
          <td colspan="2"></td>
        </tr>`;
      
      // Only add tax row if tax should be shown
      if (shouldShowTax) {
        totalsHtml += `
          <tr id="taxRow" class="table-light">
            <td colspan="4" class="text-end">Tax (${taxRate.toFixed(2)}%):</td>
            <td colspan="1" class="text-end">₹ <span id="taxAmount">${taxAmount.toFixed(2)}</span></td>
            <td colspan="2"></td>
          </tr>`;
      }
      
      totalsHtml += `
        <tr id="grandTotalRow" class="table-success fw-bold">
          <td colspan="4" class="text-end">GRAND TOTAL:</td>
          <td colspan="1" class="text-end">₹ <span id="grandTotal">${grandTotal.toFixed(2)}</span></td>
          <td colspan="2"></td>
        </tr>`;

        totalsHtml += `
        <tbody id="paymentSection">
        <tr class="payment-row table-light">
          <td colspan="4" class="text-end">Paid Amount:</td>
          <td colspan="1" class="text-end">
            ₹ <input type="number" id="paidAmount"
              class="form-control form-control-sm text-end"
              min="0" step="0.01" value="0">
          </td>
          <td colspan="2"></td>
        </tr>

        <tr class="payment-row table-warning fw-bold">
          <td colspan="4" class="text-end">Due Amount:</td>
          <td colspan="1" class="text-end">
            ₹ <span id="dueAmount">0.00</span>
          </td>
          <td colspan="2"></td>
        </tr>

        <tr class="payment-row table-info fw-bold">
          <td colspan="4" class="text-end">Payment Status:</td>
          <td colspan="1" class="text-end">
            <span id="paymentStatus" class="badge bg-danger">Due</span>
          </td>
          <td colspan="2"></td>
        </tr>
        </tbody>
        `;

      
      tableFooter.innerHTML = totalsHtml;

      const paidInput = document.getElementById('paidAmount');
      if (paidInput) {
        paidInput.addEventListener('input', calculateAndDisplayTotals);
      }
      const documentType = document.getElementById('documentType').value;
const config = documentTypesConfig[documentType];

if (config?.PaymentStatusFunctionality) {
  const paidAmount = parseFloat(document.getElementById('paidAmount')?.value) || 0;
  const dueAmount = grandTotal - paidAmount;

  const statusEl = document.getElementById('paymentStatus');
  const dueEl = document.getElementById('dueAmount');

  if (paidAmount >= grandTotal) {
    statusEl.textContent = 'Paid';
    statusEl.className = 'badge bg-success';
    dueEl.textContent = '0.00';
  } else {
    statusEl.textContent = 'Due';
    statusEl.className = 'badge bg-danger';
    dueEl.textContent = dueAmount.toFixed(2);
  }
}







      
      // Add event listener for discount percentage
      const discountInput = document.getElementById('discountPercent');
      if (discountInput) {
        discountInput.addEventListener('input', calculateAndDisplayTotals);
      }
    } else {
      // Update existing totals
      document.getElementById('subtotalAmount').textContent = subtotal.toFixed(2);
      document.getElementById('discountAmount').textContent = discountAmount.toFixed(2);
      document.getElementById('totalAfterDiscount').textContent = totalAfterDiscount.toFixed(2);
      
      // Only update tax if it should be shown
      if (shouldShowTax) {
        document.getElementById('taxAmount').textContent = taxAmount.toFixed(2);
        const taxRow = document.getElementById('taxRow');
        if (taxRow) {
          taxRow.querySelector('td:first-child').textContent = `Tax (${taxRate.toFixed(2)}%):`;
          taxRow.style.display = ''; // Make sure it's visible
        }
      } else {
        // Hide tax row if it exists
        const taxRow = document.getElementById('taxRow');
        if (taxRow) {
          taxRow.style.display = 'none';
        }
      }
      
      // Update grand total
      document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
    }
    
    return {
      subtotal,
      discountPercent,
      discountAmount,
      totalAfterDiscount,
      taxRate,
      taxAmount,
      grandTotal
    };
  }


  // Check invoice number on blur
  async function checkInvoiceNumberOnBlur() {
    const invoiceNumber = document.getElementById('invoiceNo').value.trim();
    if (invoiceNumber) {
      const exists = await checkInvoiceNumberExists(invoiceNumber);
      if (exists) {
        const invoiceNoInput = document.getElementById('invoiceNo');
        invoiceNoInput.classList.add('is-invalid');
        showStatus(`Document number "${invoiceNumber}" already exists. Please use a different number.`, 'warning');
        return true;
      } else {
        document.getElementById('invoiceNo').classList.remove('is-invalid');
        return false;
      }
    }
    return false;
  }
  
  // Show status message
  function showStatus(message, type = 'success') {
    const statusEl = document.getElementById('statusMessage');
    const statusText = document.getElementById('statusText');
    
    statusText.textContent = message;
    statusEl.className = `alert alert-${type} alert-dismissible fade show`;
    statusEl.style.display = 'block';
    
    // Auto hide after 5 seconds
    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 5000);
  }
  
  // Calculate tax amounts based on GST type
  function calculateTaxAmounts(totalAmount, discountPercent = 0) {
    const documentType = document.getElementById('documentType').value;
    const config = documentTypesConfig[documentType];
    
    if (!config || !config.showTaxRates) {
      // No tax calculation needed
      const discountAmount = totalAmount * (discountPercent / 100);
      const amountAfterDiscount = totalAmount - discountAmount;
      
      return {
        subtotal: totalAmount,
        discountPercent,
        discountAmount,
        amountAfterDiscount,
        cgstAmount: 0,
        sgstAmount: 0,
        igstAmount: 0,
        totalTax: 0,
        invoiceTotal: amountAfterDiscount,
        isIntraState: false
      };
    }
    
    const gstin = document.getElementById('clientGST').value.trim();
    const isIntraState = isIntraStateGST(gstin);
    
    // Apply discount first
    const discountAmount = totalAmount * (discountPercent / 100);
    const amountAfterDiscount = totalAmount - discountAmount;
    
    let cgstAmount = 0;
    let sgstAmount = 0;
    let igstAmount = 0;
    let totalTax = 0;
    
    if (isIntraState) {
      // Intra-state: CGST + SGST
      const cgstRate = parseFloat(document.getElementById('cgstRate').value) || 0;
      const sgstRate = parseFloat(document.getElementById('sgstRate').value) || 0;
      cgstAmount = amountAfterDiscount * (cgstRate / 100);
      sgstAmount = amountAfterDiscount * (sgstRate / 100);
      totalTax = cgstAmount + sgstAmount;
    } else {
      // Inter-state: IGST only
      const igstRate = parseFloat(document.getElementById('igstRate').value) || 0;
      igstAmount = amountAfterDiscount * (igstRate / 100);
      totalTax = igstAmount;
    }
    
    const invoiceTotal = amountAfterDiscount + totalTax;
    
    return {
      subtotal: totalAmount,
      discountPercent,
      discountAmount,
      amountAfterDiscount,
      cgstAmount,
      sgstAmount,
      igstAmount,
      totalTax,
      invoiceTotal,
      isIntraState
    };
  }
  
  // Save bill data to Firebase
  async function saveBillToFirebase(formData) {
    try {
      const user = firebase.auth().currentUser;
      if (!user) {
        throw new Error('User not authenticated. Please login.');
      }

      const documentType = document.getElementById('documentType').value;
const config = documentTypesConfig[documentType];

if (config.PaymentStatusFunctionality) {
  const totals = calculateAndDisplayTotals();
  const grandTotal = totals.grandTotal;
  const paidAmount = parseFloat(document.getElementById('paidAmount')?.value) || 0;

  const paymentStatus = paidAmount >= grandTotal ? 'Paid' : 'Due';

  formData.paymentStatus = paymentStatus;

  if (paymentStatus === 'Due') {
    formData.dueAmount = grandTotal - paidAmount;
  }
}



      
      // Add timestamp and user info
      formData.createdAt = firebase.database.ServerValue.TIMESTAMP;
      formData.updatedAt = firebase.database.ServerValue.TIMESTAMP;
      formData.createdBy = user.uid;
      // formData.createdByEmail = user.email;
      
      // Get user role from localStorage if available
      // const userRole = localStorage.getItem('userRole');
      // if (userRole) {
      //   formData.createdByRole = userRole;
      // }
      
      // Save to Firebase under "bill" node
      const billRef = firebase.database().ref('bill');
      const newBillRef = billRef.push();
      
      // Save the data
      await newBillRef.set(formData);
      
      // Return the generated bill ID
      return newBillRef.key;
    } catch (error) {
      console.error('Error saving bill:', error);
      
      // More specific error messages
      if (error.code === 'PERMISSION_DENIED') {
        throw new Error('Permission denied. You may not have write access to the bills database.');
      } else if (error.message.includes('auth')) {
        throw new Error('Authentication error. Please login again.');
      } else {
        throw new Error(`Failed to save document: ${error.message}`);
      }
    }
  }

  // Initialize with sample data
  document.addEventListener('DOMContentLoaded', async function() {
    // Load document types configuration
    await loadDocumentTypesConfig();
    
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('invoiceDate').value = today;
    document.getElementById('deliveryDate').value = " ";
    
    // Add event listeners
    document.getElementById('documentType').addEventListener('change', handleDocumentTypeChange);
    document.getElementById('clientGST').addEventListener('input', function() {
      updateTaxFieldsBasedOnGST();
      updateTotalTaxRate();
      // Update required fields after GST changes
      const documentType = document.getElementById('documentType').value;
      const config = documentTypesConfig[documentType];
      if (config) {
        updateRequiredFields(config);
      }
    });
    document.getElementById('cgstRate').addEventListener('input', updateTotalTaxRate);
    document.getElementById('sgstRate').addEventListener('input', updateTotalTaxRate);
    document.getElementById('igstRate').addEventListener('input', updateTotalTaxRate);
    document.getElementById('invoiceNo').addEventListener('blur', checkInvoiceNumberOnBlur);
    
    // Initialize form
    handleDocumentTypeChange();
  });
  
  // Event Listeners
  document.getElementById('addItemBtn').addEventListener('click', function() {
    addItem();
  });
  
  document.getElementById('resetBtn').addEventListener('click', function() {
    if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
      document.getElementById('invoiceForm').reset();
      document.getElementById('itemsTableBody').innerHTML = '';
      document.getElementById('itemsTableFooter').innerHTML = '';
      
      // Set today's date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('invoiceDate').value = today;
      document.getElementById('deliveryDate').value = today;
      
      // Reset to default document type
      document.getElementById('documentType').value = 'tax-invoice';
      handleDocumentTypeChange();
      

      
      // Reload last invoice number after reset
      loadLastInvoiceNumber();
    }
  });
  
  document.getElementById('invoiceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Check if user is authenticated
    const user = firebase.auth().currentUser;
    if (!user) {
      showStatus('Please login to generate documents.', 'danger');
      window.location.href = "login.html";
      return;
    }
    
    // Get invoice number - only if field is visible
    const invoiceNoField = document.getElementById('invoiceNoField');
    let invoiceNumber = '';
    if (!invoiceNoField.classList.contains('field-hidden')) {
      invoiceNumber = document.getElementById('invoiceNo').value.trim();
      if (!invoiceNumber) {
        showStatus('Please enter a document number.', 'danger');
        document.getElementById('invoiceNo').classList.add('is-invalid');
        return;
      }
      
      // Check if invoice number already exists
      const invoiceExists = await checkInvoiceNumberExists(invoiceNumber);
      if (invoiceExists) {
        showStatus(`Document number "${invoiceNumber}" already exists. Please use a different number.`, 'danger');
        document.getElementById('invoiceNo').classList.add('is-invalid');
        document.getElementById('invoiceNo').focus();
        return;
      }
    }
    
    // Validate required fields
    const documentType = document.getElementById('documentType').value;
    const config = documentTypesConfig[documentType];
    
    if (!config) {
      showStatus('Invalid document type selected.', 'danger');
      return;
    }
    
    // Check required fields - only if they are visible
    let isValid = true;
    
    // Check client name
    if (config.requireClientName && !document.getElementById('clientName').value.trim()) {
      document.getElementById('clientName').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('clientName').classList.remove('is-invalid');
    }
    
    // Check client GST if required and visible
    const clientGSTField = document.getElementById('clientGSTField');
    if (config.requireClientGST && !clientGSTField.classList.contains('field-hidden') && !document.getElementById('clientGST').value.trim()) {
      document.getElementById('clientGST').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('clientGST').classList.remove('is-invalid');
    }
    
    // Check other required fields similarly...
    
    // Check if there are any items
    const itemRows = document.querySelectorAll('#itemsTableBody tr');
    if (itemRows.length === 0) {
      showStatus('Please add at least one item to the document.', 'danger');
      isValid = false;
    }
    
    if (!isValid) {
      showStatus('Please fill in all required fields.', 'danger');
      return;
    }
    
    // Get totals including discount
    const totals = calculateAndDisplayTotals();
    const discountPercent = parseFloat(document.getElementById('discountPercent')?.value) || 0;
    
    // Check GST type if GST field is visible
    let gstin = '';
    let isIntraState = true;
    if (!document.getElementById('clientGSTField').classList.contains('field-hidden')) {
      gstin = document.getElementById('clientGST').value.trim();
      isIntraState = isIntraStateGST(gstin);
    }
    
    const formData = {
        documentType: documentType,
        documentTitle: config.name,
        //billToTitle: config.billToTitle,
        //invoiceDetailsTitle: config.invoiceDetailsTitle,
        //clientNameLabel: config.clientNameLabel,
        //documentNumberLabel: config.documentNumberLabel,
        //documentDateLabel: config.documentDateLabel,
        
        clientName: document.getElementById('clientName').value,
        clientAddress: document.getElementById('clientAddress').value,
        clientState: document.getElementById('clientState').value,
        clientGST: gstin,
        
        invoiceNo: invoiceNumber,
        invoiceDate: document.getElementById('invoiceDate').value,
        placeOfSupply: document.getElementById('placeOfSupply').value,
        
        items: [], // Initialize items as empty array
        
        // GST type info
        isIntraState: isIntraState,
        
        // Discount information
        discountPercent: discountPercent,
        discountAmount: totals.discountAmount,
        
        // Totals
        subtotal: totals.subtotal,
        totalAfterDiscount: totals.totalAfterDiscount,
        taxRate: totals.taxRate,
        taxAmount: totals.taxAmount,
        grandTotal: totals.grandTotal,
        
        // Status tracking
        status: 'active',
        isArchived: false,
        
        // Save flags from configuration
        saveTransportation: config.saveTransportation,
        saveTaxRates: config.saveTaxRates,
        saveBankDetails: config.saveBankDetails,
        saveShipTo: config.saveShipTo
    };
    
    // Add Ship To if configured to save and section is visible
    const shipToSection = document.getElementById('shipToSection');
    if (config.saveShipTo && !shipToSection.classList.contains('d-none')) {
        formData.shipTo = document.getElementById('shipTo').value;
    }
    
    // Add transportation details if configured to save and section is visible
    const transportationSection = document.getElementById('transportationSection');
    if (config.saveTransportation && !transportationSection.classList.contains('d-none')) {
        formData.transportName = document.getElementById('transportName').value;
        formData.vehicleNumber = document.getElementById('vehicleNumber').value;
        formData.deliveryDate = document.getElementById('deliveryDate').value;
        formData.deliveryLocation = document.getElementById('deliveryLocation').value;
    }
    
    // Add tax rates if configured to save and tax calculation is enabled
    if (config.saveTaxRates && config.showTaxRates) {
        // Check if tax section is actually visible
        const taxRatesSection = document.getElementById('taxRatesSection');
        if (!taxRatesSection.classList.contains('d-none')) {
            if (isIntraState) {
                // Intra-state: Save CGST and SGST
                formData.cgstRate = parseFloat(document.getElementById('cgstRate').value) || 0;
                formData.sgstRate = parseFloat(document.getElementById('sgstRate').value) || 0;
                formData.totalTaxRate = parseFloat(document.getElementById('totalTaxRate').value) || 0;
                formData.cgstAmount = totals.taxAmount / 2; // Assuming equal CGST and SGST
                formData.sgstAmount = totals.taxAmount / 2;
            } else {
                // Inter-state: Save IGST only
                formData.igstRate = parseFloat(document.getElementById('igstRate').value) || 0;
                formData.totalTaxRate = parseFloat(document.getElementById('totalTaxRate').value) || 0;
                formData.igstAmount = totals.taxAmount;
            }
        }
    }
    
    // Add bank details if configured to save and section is visible
    const bankDetailsSection = document.getElementById('bankDetailsSection');
    if (config.saveBankDetails && !bankDetailsSection.classList.contains('d-none')) {
        formData.bankName = document.getElementById('bankName').value;
        formData.accountNo = document.getElementById('accountNo').value;
        formData.ifscCode = document.getElementById('ifscCode').value;
        formData.accountHolder = document.getElementById('accountHolder').value;
    }
    
    // Add additional info if field5 has value and section is visible
    const additionalInfoSection = document.getElementById('additionalInfoSection');
    const field5Value = document.getElementById('field5').value;
    if (field5Value && !additionalInfoSection.classList.contains('d-none')) {
        formData.field5 = field5Value;
    }
    
    // Collect items with individual amounts
    itemRows.forEach((row, index) => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const amount = quantity * price;
        
        formData.items.push({
            id: index + 1,
            name: row.querySelector('.item-name').value,
            hsn: row.querySelector('.item-hsn').value,
            quantity: quantity,
            unit: row.querySelector('.item-unit').value,
            price: price,
            amount: amount
        });
    });
    
    // Format dates for display
    try {
        const invoiceDateObj = new Date(formData.invoiceDate);
        formData.invoiceDateFormatted = invoiceDateObj.toLocaleDateString('en-GB');
    } catch (e) {
        formData.invoiceDateFormatted = formData.invoiceDate;
    }
    
    if (formData.deliveryDate) {
        try {
            const deliveryDateObj = new Date(formData.deliveryDate);
            formData.deliveryDateFormatted = deliveryDateObj.toLocaleDateString('en-GB');
        } catch (e) {
            formData.deliveryDateFormatted = formData.deliveryDate;
        }
    }
    
    try {
        // Show loading with spinner
        const generateBtn = document.getElementById('generateBtn');
        const originalText = generateBtn.innerHTML;
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Saving...';
        generateBtn.disabled = true;
        
        // Save to Firebase
        const billId = await saveBillToFirebase(formData);
        
        // Show success message
        showStatus('Document saved successfully! Opening document...', 'success');
        
        // Reset button text
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
        
        // Open document page with bill ID
        setTimeout(() => {
            window.open(`bill.html?billId=${billId}`, '_blank');
            // Reload last invoice number after saving
            loadLastInvoiceNumber();
        }, 1500);
        
    } catch (error) {
        console.error('Error:', error);
        showStatus(error.message, 'danger');
        
        // Reset button text
        const generateBtn = document.getElementById('generateBtn');
        generateBtn.innerHTML = '<i class="fas fa-file-export me-1"></i> Generate Document';
        generateBtn.disabled = false;
    }
  });
 
</script>
<script src="js/invoice.js"></script>
<!-- Bootstrap JS Bundle --> 
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>