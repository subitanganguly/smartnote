<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Client Report - Barman Construction</title>
  <link rel="icon" type="image/png" href="img/tab-logo.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style/style.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Add Bootstrap Datepicker CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker.min.css">
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="js/firebaseconfig.js"></script>
  <script src="js/all.js"></script>
  <style>
    .card {
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .payment-in {
      color: #28a745;
      font-weight: 600;
    }
    
    .payment-out {
      color: #dc3545;
      font-weight: 600;
    }
    
    .document-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    
    .total-amount {
      font-size: 18px;
      font-weight: 700;
    }
    
    .client-name {
      font-weight: 600;
      color: #2c3e50;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }
    
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 300px;
    }
    
    .table th {
      border-top: none;
      background-color: #f8f9fa;
      font-weight: 600;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }
    
    .summary-card {
      border-left: 4px solid;
    }
    
    .summary-card.incoming {
      border-left-color: #28a745;
    }
    
    .summary-card.outgoing {
      border-left-color: #dc3545;
    }
    
    .summary-card.balance {
      border-left-color: #007bff;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
    
    .status-paid {
      background-color: #28a745;
    }
    
    .status-pending {
      background-color: #ffc107;
    }
    
    .status-overdue {
      background-color: #dc3545;
    }
    
    /* Modal styles - REMOVED */
    
    @media (max-width: 768px) {
      .chart-container {
        height: 250px;
      }
    }
  </style>
</head>
<body>

<!-- Navbar will load here -->
<div id="nav-placeholder"></div>

<!-- Main Content -->
<div class="content p-3">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="mb-1">Client Payment Report</h4>
      <p class="text-muted mb-0">Client-wise payment in/out summary with detailed breakdown</p>
    </div>
    <div class="d-flex gap-2">
      <button type="button" id="refreshBtn" class="btn btn-outline-primary">
        <i class="fas fa-sync-alt me-1"></i> Refresh
      </button>
      <button type="button" id="exportBtn" class="btn btn-outline-success">
        <i class="fas fa-download me-1"></i> Export
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="fix-card mb-2 p-3">
    <div class="card-body">
      <div class="row g-3">
        <!-- Client Search -->
        <div class="col-md-4">
          <label for="clientSearch" class="form-label">Search Client</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="clientSearch" placeholder="Search client by name...">
          </div>
        </div>
        
        <!-- Document Types -->
        <div class="col-md-4">
          <label class="form-label">Document Types</label>
          <select class="form-select" id="docTypeFilter" multiple>
            <option value="tax-invoice" selected>Tax Invoice</option>
            <option value="proforma-invoice" selected>Proforma Invoice</option>
            <option value="purchase-invoice" selected>Purchase Invoice</option>
            <option value="delivery-challan">Delivery Challan</option>
            <option value="quotation">Quotation</option>
            <option value="cash-memo">Cash Memo</option>
          </select>
          <small class="text-muted">Hold Ctrl to select multiple types</small>
        </div>
        
        <!-- Date Range -->
        <div class="col-md-4">
          <label class="form-label">Date Range</label>
          <div class="row g-2">
            <div class="col-md-6">
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                <input type="text" class="form-control datepicker" id="dateFrom" placeholder="From Date">
              </div>
            </div>
            <div class="col-md-6">
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                <input type="text" class="form-control datepicker" id="dateTo" placeholder="To Date">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Buttons -->
        <div class="col-md-12">
          <div class="d-flex justify-content-end gap-2">
            <button type="button" id="clearFilters" class="btn btn-outline-secondary">
              <i class="fas fa-times me-1"></i> Clear Filters
            </button>
            <button type="button" id="applyFilters" class="btn btn-primary">
              <i class="fas fa-filter me-1"></i> Apply Filters
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4" id="summaryCards">
    <!-- Summary cards will be loaded here -->
  </div>

  <!-- Charts -->
  <div class="row mb-4">
    <div class="col-lg-6">
      <div class="fix-card p-3">
        <div class="card-body">
          <h6 class="card-title">Payment In/Out by Client</h6>
          <div class="chart-container">
            <canvas id="paymentChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="fix-card p-3">
        <div class="card-body">
          <h6 class="card-title">Document Type Distribution</h6>
          <div class="chart-container">
            <canvas id="docTypeChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Client Summary Table -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">Client Summary</h5>
        <div class="text-muted" id="clientCount">Loading...</div>
      </div>
      
      <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="table table-hover" id="clientTable">
          <thead>
            <tr>
              <th>Client Name</th>
              <th>Payment In <small class="text-success">(Received)</small></th>
              <th>Payment Out <small class="text-danger">(Paid)</small></th>
              <th>Balance</th>
              <th>Total Documents</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="clientTableBody">
            <!-- Client data will be loaded here -->
          </tbody>
        </table>
      </div>
      
      <div id="emptyState" class="empty-state d-none">
        <i class="fas fa-users"></i>
        <h5>No clients found</h5>
        <p class="mb-3">No client data matches your filter criteria.</p>
        <button type="button" id="clearAllFiltersBtn" class="btn btn-primary">
          <i class="fas fa-times me-1"></i> Clear All Filters
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Status Message -->
<div id="statusMessage" class="alert alert-dismissible fade" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 1050; display: none;">
  <span id="statusText"></span>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>

<script>
  // Firebase initialization
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  // Global variables
  let allBills = [];
  let clientSummary = {};
  let paymentChart = null;
  let docTypeChart = null;
  
  // Document type configuration
  const documentTypes = {
    'tax-invoice': { label: 'Tax Invoice', type: 'incoming', color: '#28a745' },
    'proforma-invoice': { label: 'Proforma Invoice', type: 'incoming', color: '#17a2b8' },
    'purchase-invoice': { label: 'Purchase Invoice', type: 'outgoing', color: '#dc3545' },
    'delivery-challan': { label: 'Delivery Challan', type: 'incoming', color: '#ffc107' },
    'quotation': { label: 'Quotation', type: 'neutral', color: '#6c757d' },
    'cash-memo': { label: 'Cash Memo', type: 'incoming', color: '#20c997' }
  };

  // Check authentication
  firebase.auth().onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "login.html";
    } else {
      loadAllBills();
    }
  });

  // Show status message
  function showStatus(message, type = 'success') {
    const statusEl = document.getElementById('statusMessage');
    const statusText = document.getElementById('statusText');
    
    statusText.textContent = message;
    statusEl.className = `alert alert-${type} alert-dismissible fade show`;
    statusEl.style.display = 'block';
    
    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 5000);
  }

  // Format currency
  function formatCurrency(amount) {
    if (typeof amount !== 'number') amount = parseFloat(amount) || 0;
    return '₹' + amount.toLocaleString('en-IN', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  // Format date
  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-GB');
    } catch (e) {
      return dateString;
    }
  }

  // Load all bills from Firebase
  async function loadAllBills() {
    try {
      const billsRef = firebase.database().ref('bill');
      const snapshot = await billsRef.once('value');
      
      if (!snapshot.exists()) {
        allBills = [];
        showEmptyState();
        return;
      }
      
      const billsArray = [];
      snapshot.forEach(childSnapshot => {
        const bill = childSnapshot.val();
        bill.id = childSnapshot.key;
        
        // Only include non-archived bills
        if (!bill.isArchived) {
          billsArray.push(bill);
        }
      });
      
      allBills = billsArray;
      generateClientSummary();
      applyFilters();
      
    } catch (error) {
      console.error('Error loading bills:', error);
      showStatus('Failed to load data: ' + error.message, 'danger');
      showEmptyState();
    }
  }

  // Generate client summary from bills
  function generateClientSummary() {
    clientSummary = {};
    
    allBills.forEach(bill => {
      const clientName = bill.clientName || 'Unknown Client';
      const docType = bill.documentType;
      const amount = parseFloat(bill.grandTotal || bill.invoiceTotal || 0);
      const docConfig = documentTypes[docType] || { type: 'neutral' };
      
      // Initialize client if not exists
      if (!clientSummary[clientName]) {
        clientSummary[clientName] = {
          incoming: 0,
          outgoing: 0,
          documents: [],
          docTypeCount: {},
          balance: 0
        };
      }
      
      // Add to client summary
      if (docConfig.type === 'incoming') {
        clientSummary[clientName].incoming += amount;
      } else if (docConfig.type === 'outgoing') {
        clientSummary[clientName].outgoing += amount;
      }
      
      // Calculate balance
      clientSummary[clientName].balance = 
        clientSummary[clientName].incoming - clientSummary[clientName].outgoing;
      
      // Add document details
      clientSummary[clientName].documents.push({
        id: bill.id,
        invoiceNo: bill.invoiceNo || 'N/A',
        date: bill.invoiceDate || bill.createdAt,
        type: docType,
        typeLabel: docConfig.label || docType,
        amount: amount,
        status: bill.paymentStatus || 'pending'
      });
      
      // Count document types
      if (!clientSummary[clientName].docTypeCount[docType]) {
        clientSummary[clientName].docTypeCount[docType] = 0;
      }
      clientSummary[clientName].docTypeCount[docType]++;
    });
  }

  // Apply filters and display data
  function applyFilters() {
    const clientSearch = document.getElementById('clientSearch').value.toLowerCase();
    const docTypeSelect = document.getElementById('docTypeFilter');
    const selectedDocTypes = Array.from(docTypeSelect.selectedOptions).map(opt => opt.value);
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    // Filter client summary
    let filteredClients = {};
    let totalIncoming = 0;
    let totalOutgoing = 0;
    let totalBalance = 0;
    let totalDocuments = 0;
    
    Object.keys(clientSummary).forEach(clientName => {
      // Filter by client name
      if (clientSearch && !clientName.toLowerCase().includes(clientSearch)) {
        return;
      }
      
      // Filter client documents by date and type
      const filteredDocs = clientSummary[clientName].documents.filter(doc => {
        // Filter by document type
        if (selectedDocTypes.length > 0 && !selectedDocTypes.includes(doc.type)) {
          return false;
        }
        
        // Filter by date
        if (dateFrom || dateTo) {
          const docDate = new Date(doc.date);
          if (dateFrom) {
            const fromDate = new Date(dateFrom.split('/').reverse().join('-'));
            if (docDate < fromDate) return false;
          }
          if (dateTo) {
            const toDate = new Date(dateTo.split('/').reverse().join('-'));
            toDate.setHours(23, 59, 59, 999);
            if (docDate > toDate) return false;
          }
        }
        
        return true;
      });
      
      if (filteredDocs.length === 0) {
        return;
      }
      
      // Calculate filtered amounts
      let clientIncoming = 0;
      let clientOutgoing = 0;
      
      filteredDocs.forEach(doc => {
        const docConfig = documentTypes[doc.type] || { type: 'neutral' };
        if (docConfig.type === 'incoming') {
          clientIncoming += doc.amount;
        } else if (docConfig.type === 'outgoing') {
          clientOutgoing += doc.amount;
        }
      });
      
      const clientBalance = clientIncoming - clientOutgoing;
      
      filteredClients[clientName] = {
        ...clientSummary[clientName],
        incoming: clientIncoming,
        outgoing: clientOutgoing,
        balance: clientBalance,
        documents: filteredDocs,
        filtered: true
      };
      
      // Update totals
      totalIncoming += clientIncoming;
      totalOutgoing += clientOutgoing;
      totalBalance += clientBalance;
      totalDocuments += filteredDocs.length;
    });
    
    // Update summary cards
    updateSummaryCards(totalIncoming, totalOutgoing, totalBalance, totalDocuments);
    
    // Update client table
    updateClientTable(filteredClients);
    
    // Update charts
    updateCharts(filteredClients);
  }

  // Update summary cards
  function updateSummaryCards(incoming, outgoing, balance, totalDocs) {
    const summaryCards = document.getElementById('summaryCards');
    
    summaryCards.innerHTML = `
      <div class="col-md-3">
        <div class="card summary-card incoming">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <small class="text-muted">Total Payment In</small>
                <div class="total-amount payment-in">${formatCurrency(incoming)}</div>
              </div>
              <i class="fas fa-arrow-down text-success fs-3 opacity-50"></i>
            </div>
            <small class="text-muted">Total received from clients</small>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card summary-card outgoing">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <small class="text-muted">Total Payment Out</small>
                <div class="total-amount payment-out">${formatCurrency(outgoing)}</div>
              </div>
              <i class="fas fa-arrow-up text-danger fs-3 opacity-50"></i>
            </div>
            <small class="text-muted">Total paid to suppliers</small>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card summary-card balance">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <small class="text-muted">Net Balance</small>
                <div class="total-amount ${balance >= 0 ? 'payment-in' : 'payment-out'}">
                  ${formatCurrency(balance)}
                </div>
              </div>
              <i class="fas fa-scale-balanced text-primary fs-3 opacity-50"></i>
            </div>
            <small class="text-muted">Incoming - Outgoing</small>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <small class="text-muted">Total Documents</small>
                <div class="total-amount">${totalDocs}</div>
              </div>
              <i class="fas fa-file-invoice text-info fs-3 opacity-50"></i>
            </div>
            <small class="text-muted">Filtered documents</small>
          </div>
        </div>
      </div>
    `;
  }

  // Update client table
  function updateClientTable(filteredClients) {
    const loadingSpinner = document.getElementById('loadingSpinner');
    const emptyState = document.getElementById('emptyState');
    const clientTableBody = document.getElementById('clientTableBody');
    const clientCount = document.getElementById('clientCount');
    
    // Hide loading spinner
    loadingSpinner.style.display = 'none';
    
    const clientNames = Object.keys(filteredClients);
    
    if (clientNames.length === 0) {
      clientTableBody.innerHTML = '';
      emptyState.classList.remove('d-none');
      clientCount.textContent = '0 clients found';
      return;
    }
    
    emptyState.classList.add('d-none');
    clientCount.textContent = `${clientNames.length} client${clientNames.length !== 1 ? 's' : ''} found`;
    
    // Sort clients by balance (highest to lowest)
    const sortedClients = clientNames.sort((a, b) => {
      return filteredClients[b].balance - filteredClients[a].balance;
    });
    
    let html = '';
    sortedClients.forEach(clientName => {
      const client = filteredClients[clientName];
      const balanceClass = client.balance >= 0 ? 'payment-in' : 'payment-out';
      const balanceIcon = client.balance >= 0 ? 'fa-arrow-up text-success' : 'fa-arrow-down text-danger';
      
      html += `
        <tr>
          <td>
            <div class="client-name">${clientName}</div>
            <small class="text-muted">${client.documents.length} document${client.documents.length !== 1 ? 's' : ''}</small>
          </td>
          <td class="payment-in">${formatCurrency(client.incoming)}</td>
          <td class="payment-out">${formatCurrency(client.outgoing)}</td>
          <td class="${balanceClass}">
            <i class="fas ${balanceIcon} me-1"></i>
            ${formatCurrency(client.balance)}
          </td>
          <td>
            ${client.documents.length}
            <div class="mt-1">
              ${Object.keys(client.docTypeCount).map(type => {
                const config = documentTypes[type] || { label: type };
                return `<span class="badge bg-secondary document-badge me-1 mb-1">${config.label}: ${client.docTypeCount[type]}</span>`;
              }).join('')}
            </div>
          </td>
          <td>
            <button class="btn btn-sm btn-outline-primary view-client-btn" data-client-name="${clientName}">
              <i class="fas fa-eye me-1"></i> View Details
            </button>
          </td>
        </tr>
      `;
    });
    
    clientTableBody.innerHTML = html;
    
    // Add event listeners to view buttons - MODIFIED TO OPEN SEPARATE PAGE
    document.querySelectorAll('.view-client-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const clientName = encodeURIComponent(this.dataset.clientName);
        // Open client-details.html in a new tab with client name as parameter
        window.open(`client-details.html?client=${clientName}`, '_blank');
      });
    });
  }

  // Update charts
  function updateCharts(filteredClients) {
    const clientNames = Object.keys(filteredClients);
    
    // Prepare data for payment chart
    const paymentData = {
      labels: clientNames,
      datasets: [
        {
          label: 'Payment In',
          data: clientNames.map(name => filteredClients[name].incoming),
          backgroundColor: 'rgba(40, 167, 69, 0.5)',
          borderColor: 'rgba(40, 167, 69, 1)',
          borderWidth: 1
        },
        {
          label: 'Payment Out',
          data: clientNames.map(name => filteredClients[name].outgoing),
          backgroundColor: 'rgba(220, 53, 69, 0.5)',
          borderColor: 'rgba(220, 53, 69, 1)',
          borderWidth: 1
        }
      ]
    };
    
    // Prepare data for document type chart
    const docTypeCounts = {};
    clientNames.forEach(name => {
      Object.keys(filteredClients[name].docTypeCount).forEach(type => {
        docTypeCounts[type] = (docTypeCounts[type] || 0) + filteredClients[name].docTypeCount[type];
      });
    });
    
    const docTypeData = {
      labels: Object.keys(docTypeCounts).map(type => documentTypes[type]?.label || type),
      datasets: [{
        data: Object.values(docTypeCounts),
        backgroundColor: Object.keys(docTypeCounts).map(type => documentTypes[type]?.color || '#6c757d'),
        borderWidth: 1
      }]
    };
    
    // Destroy existing charts
    if (paymentChart) {
      paymentChart.destroy();
    }
    if (docTypeChart) {
      docTypeChart.destroy();
    }
    
    // Create payment chart
    const paymentCtx = document.getElementById('paymentChart').getContext('2d');
    paymentChart = new Chart(paymentCtx, {
      type: 'bar',
      data: paymentData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '₹' + value.toLocaleString('en-IN');
              }
            }
          }
        }
      }
    });
    
    // Create document type chart
    const docTypeCtx = document.getElementById('docTypeChart').getContext('2d');
    docTypeChart = new Chart(docTypeCtx, {
      type: 'doughnut',
      data: docTypeData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
          }
        }
      }
    });
  }

  // Show empty state
  function showEmptyState() {
    const loadingSpinner = document.getElementById('loadingSpinner');
    const emptyState = document.getElementById('emptyState');
    const clientTableBody = document.getElementById('clientTableBody');
    const clientCount = document.getElementById('clientCount');
    
    loadingSpinner.style.display = 'none';
    clientTableBody.innerHTML = '';
    emptyState.classList.remove('d-none');
    clientCount.textContent = '0 clients found';
  }

  // Export data to CSV
  function exportToCSV() {
    const clientNames = Object.keys(clientSummary);
    if (clientNames.length === 0) {
      showStatus('No data to export', 'warning');
      return;
    }
    
    let csv = 'Client Name,Payment In,Payment Out,Balance,Total Documents,Document Types\n';
    
    clientNames.forEach(name => {
      const client = clientSummary[name];
      const docTypes = Object.keys(client.docTypeCount).map(type => {
        const config = documentTypes[type] || { label: type };
        return `${config.label}: ${client.docTypeCount[type]}`;
      }).join('; ');
      
      csv += `"${name}",${client.incoming},${client.outgoing},${client.balance},${client.documents.length},"${docTypes}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `client_report_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showStatus('Report exported successfully!', 'success');
  }

  // Clear all filters
  function clearAllFilters() {
    document.getElementById('clientSearch').value = '';
    document.getElementById('docTypeFilter').selectedIndex = -1;
    // Select default types
    ['tax-invoice', 'proforma-invoice', 'purchase-invoice'].forEach(value => {
      const option = document.querySelector(`#docTypeFilter option[value="${value}"]`);
      if (option) option.selected = true;
    });
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    
    applyFilters();
    showStatus('All filters cleared', 'info');
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize date pickers
    $('.datepicker').datepicker({
      format: 'dd/mm/yyyy',
      autoclose: true,
      todayHighlight: true
    });
    
    // Apply filters button
    document.getElementById('applyFilters').addEventListener('click', applyFilters);
    
    // Clear filters button
    document.getElementById('clearFilters').addEventListener('click', clearAllFilters);
    
    // Clear all filters button in empty state
    document.getElementById('clearAllFiltersBtn').addEventListener('click', clearAllFilters);
    
    // Export button
    document.getElementById('exportBtn').addEventListener('click', exportToCSV);
    
    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', function() {
      const btn = this;
      const originalHtml = btn.innerHTML;
      
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Refreshing...';
      btn.disabled = true;
      
      loadAllBills();
      
      setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
      }, 1000);
    });
    
    // Search input with debounce
    let searchTimeout;
    document.getElementById('clientSearch').addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(applyFilters, 300);
    });
    
    // Document type filter change
    document.getElementById('docTypeFilter').addEventListener('change', applyFilters);
    
    // Date inputs change
    document.getElementById('dateFrom').addEventListener('change', applyFilters);
    document.getElementById('dateTo').addEventListener('change', applyFilters);
  });
</script>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>