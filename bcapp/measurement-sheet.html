<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Barman Construction</title>
  <link rel="icon" type="image/png" href="img/tab-logo.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <link href="style/style.css" rel="stylesheet">
  <style>
    /* Add search bar styling */
    .search-container {
      max-width: 500px;
      margin-bottom: 10px;
    }
    
    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      color: #6c757d;
    }
    
    .search-input {
      padding-left: 45px;
      border-radius: 25px;
    }
    
    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
    }
    
    .no-results i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .measurement-sheet-card {
  position: relative;
  z-index: 1;
}

.measurement-sheet-card:hover {
  z-index: 5;
}

.dropdown-menu {
  z-index: 1055 !important; /* higher than cards */
}

  </style>
</head>
<body>

<!-- Create MeasurementSheet Modal -->
<div class="modal fade" id="createMeasurementSheetModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Sheet</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">

  <!-- Measurement Sheet Name -->
  <div class="mb-3">
    <label class="form-label">Measurement Sheet Name</label>
    <input type="text" id="MeasurementSheetName" class="form-control"
           placeholder="Enter Measurement Sheet name">
  </div>

  <!-- UNDER (Multiple) -->
  <div class="mb-3">
    <label class="form-label">Under</label>
    <div id="underList"></div>
    <button type="button" class="btn btn-sm btn-outline-primary mt-2"
            onclick="addUnderField()">
      <i class="bi bi-plus"></i> Add Under
    </button>
  </div>

  <!-- FOR ITEM (Multiple) -->
  <div class="mb-3">
    <label class="form-label">For Item</label>
    <div id="forItemList"></div>
    <button type="button" class="btn btn-sm btn-outline-primary mt-2"
            onclick="addForItemField()">
      <i class="bi bi-plus"></i> Add Item
    </button>
  </div>

</div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="saveMeasurementSheet()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Navbar will load here -->
<div id="nav-placeholder"></div>

<!-- Main Content -->
<div class="content p-3">
  
  <div class="d-flex justify-content-between align-items-center mb-2 p-2">
    <h4 class="text-nowrap top-h">
        <span class="d-none d-sm-inline"><i class="bi bi-clipboard-data"></i> Measurement Sheet</span>
        </h4>
    <button class="btn button2 foradmin" data-bs-toggle="modal" data-bs-target="#createMeasurementSheetModal" id="createMeasurementSheetBtn">
      <i class="fas fa-plus"></i> <span class="d-none d-lg-inline">Create Sheet</span>
    </button>
  </div>
  
  <!-- Search Bar -->
  <div class="search-container">
    <div class="position-relative">
      <i class="bi bi-search search-icon"></i>
      <input type="text" 
             id="searchInput" 
             class="form-control search-input" 
             placeholder="Search measurement sheets by name..."
             oninput="filterMeasurementSheets()">
    </div>
  </div>
  
  <!-- measurementSheet Container -->
  <div class="row" id="measurementSheetContainer">
    <!-- measurementSheet will be loaded here -->
  </div>
  
  <!-- No Results Message (hidden by default) -->
  <div id="noResultsMessage" class="no-results" style="display: none;">
    <i class="bi bi-search"></i>
    <h4>No matching measurement sheets found</h4>
    <p>Try adjusting your search terms</p>
  </div>
  
  <div class="loader text-center mt-4" id="loadingMessage">
    <section class="loader">
      <div class="slider" style="--i:0"></div>
      <div class="slider" style="--i:1"></div>
      <div class="slider" style="--i:2"></div>
      <div class="slider" style="--i:3"></div>
      <div class="slider" style="--i:4"></div>
    </section>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="js/firebaseconfig.js"></script>
<script src="js/all.js"></script>

<script>
  // Initialize Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  const auth = firebase.auth();
  const database = firebase.database();
  let currentUser = null;
  let currentUserData = null;
  let editingSheetId = null;
  let allMeasurementSheets = []; // Store all sheets for filtering


  // Check authentication
  auth.onAuthStateChanged(async (user) => {
  if (!user) {
    window.location.href = "login.html";
  } else {
    currentUser = user;
    loadmeasurementSheet();
    loadItemSuggestions();
  }
});

async function loadmeasurementSheet() {
  const container = document.getElementById('measurementSheetContainer');
  const loadingMessage = document.getElementById('loadingMessage');
  const noResultsMessage = document.getElementById('noResultsMessage');

  container.innerHTML = '';
  loadingMessage.style.display = 'block';
  noResultsMessage.style.display = 'none';

  try {
    const snapshot = await database.ref('measurementSheet').once('value');
    const data = snapshot.val();

    loadingMessage.style.display = 'none';

    if (!data) {
      showNomeasurementSheetMessage('No Measurement Sheets Found');
      return;
    }

    // Store all sheets for filtering
    allMeasurementSheets = [];
    
    Object.keys(data).forEach(id => {
      const sheet = data[id];
      
      // Store sheet data for filtering
      allMeasurementSheets.push({
        id: id,
        name: sheet.MeasurementSheetName || '',
        createdAt: sheet.createdAt || '',
        element: null // Will store the HTML element
      });

      const col = document.createElement('div');
      col.className = 'col-12 col-sm-6 col-md-4 col-lg-3 mb-4 measurement-sheet-card';

     col.innerHTML = `
<div class="card h-100 border-0 measurement-card" 
     style="cursor: pointer;"
     onclick="window.location.href='measurementSheetDetails.html?id=${id}'">
    
    <!-- Card Header -->
    <div class="card-header d-flex justify-content-end align-items-center">
       
        <!-- Three-dot dropdown menu -->
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary" 
                    type="button" 
                    data-bs-toggle="dropdown" 
                    aria-expanded="false"
                    onclick="event.stopPropagation()">
                <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li>
                    <a class="dropdown-item" 
                       href="measurementSheetDetails.html?id=${id}"
                       onclick="event.stopPropagation()">
                        <i class="bi bi-eye me-2"></i>Open
                    </a>
                </li>
                <li>
                    <button class="dropdown-item" 
                            onclick="event.stopPropagation(); editMeasurementSheet('${id}')">
                        <i class="bi bi-pencil me-2"></i>Edit
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" 
                            onclick="event.stopPropagation(); exportSheetToExcel('${id}', '${escapeHtml(sheet.MeasurementSheetName)}')">
                        <i class="bi bi-file-excel me-2"></i>Export Excel
                    </button>
                </li>
                ${userRole === 'admin' ? `
                <li><hr class="dropdown-divider"></li>
                <li>
                    <button class="dropdown-item text-danger" 
                            onclick="event.stopPropagation(); deleteMeasurementSheet('${id}', '${escapeHtml(sheet.MeasurementSheetName)}')">
                        <i class="bi bi-trash me-2"></i>Delete
                    </button>
                </li>
                ` : ''}
            </ul>
        </div>
    </div>

    <!-- Card Body -->
    <div class="card-body d-flex flex-column">
       <h5 class="fw-bold text-primary text-truncate measurement-sheet-name">
            <i class="bi bi-clipboard-data me-1"></i>
            ${escapeHtml(sheet.MeasurementSheetName)}
        </h5>
        <!-- You can add more card content here if needed -->
        <div class="mt-auto text-muted small">
            <i class="bi bi-info-circle me-1"></i>
            Click anywhere to open
        </div>
    </div>
</div>
`;
      container.appendChild(col);
      
      // Store reference to the element
      const index = allMeasurementSheets.findIndex(s => s.id === id);
      if (index !== -1) {
        allMeasurementSheets[index].element = col;
      }
    });

  } catch (error) {
    console.error('Error loading measurementSheet:', error);
    loadingMessage.style.display = 'none';
    showNomeasurementSheetMessage('Failed to load Measurement Sheets');
  }
}

// Filter measurement sheets based on search input
function filterMeasurementSheets() {
  const searchInput = document.getElementById('searchInput');
  const searchTerm = searchInput.value.trim().toLowerCase();
  const noResultsMessage = document.getElementById('noResultsMessage');
  const container = document.getElementById('measurementSheetContainer');
  
  let visibleCount = 0;
  
  // Filter and show/hide cards
  allMeasurementSheets.forEach(sheet => {
    const card = sheet.element;
    if (card) {
      const sheetName = sheet.name.toLowerCase();
      const isVisible = sheetName.includes(searchTerm) || searchTerm === '';
      
      card.style.display = isVisible ? '' : 'none';
      if (isVisible) visibleCount++;
    }
  });
  
  // Show/hide no results message
  if (visibleCount === 0 && searchTerm !== '') {
    noResultsMessage.style.display = 'block';
  } else {
    noResultsMessage.style.display = 'none';
  }
}

// Show message when no measurementSheet
function showNomeasurementSheetMessage(message) {
  const container = document.getElementById('measurementSheetContainer');
  const loadingMessage = document.getElementById('loadingMessage');
  const noResultsMessage = document.getElementById('noResultsMessage');

  if (loadingMessage) {
    loadingMessage.style.display = 'none';
  }
  
  noResultsMessage.style.display = 'none';

  container.innerHTML = `
    <div class="col-12 text-center py-5">
      <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
      <h4 class="text-muted">${message}</h4>

      ${
        userRole === 'admin'
          ? `
            <button class="btn btn-primary mt-3"
              data-bs-toggle="modal"
              data-bs-target="#createMeasurementSheetModal">
              <i class="fas fa-plus"></i> Create Your First Measurement Sheet
            </button>
          `
          : `
            <p class="text-muted">
              Contact administrator to get assigned to Measurement Sheet.
            </p>
          `
      }
    </div>
  `;
}

async function editMeasurementSheet(sheetId) {

  editingSheetId = sheetId;

  const snapshot = await database.ref(`measurementSheet/${sheetId}`).once("value");
  const data = snapshot.val();
  if (!data) return;

  // Set title
  document.querySelector('#createMeasurementSheetModal .modal-title')
    .innerText = "Edit Measurement Sheet";

  // Fill name
  document.getElementById('MeasurementSheetName').value =
    data.MeasurementSheetName || "";

  // Clear lists
  document.getElementById("underList").innerHTML = "";
  document.getElementById("forItemList").innerHTML = "";

  // Fill UNDER
  if (Array.isArray(data.under)) {
    data.under.forEach(u => addUnderField(u));
  }

  // Fill FOR ITEM
  if (Array.isArray(data.forItem)) {
    data.forItem.forEach(i => addForItemField(i));
  }

  // Open modal
  new bootstrap.Modal(
    document.getElementById('createMeasurementSheetModal')
  ).show();
}



  // Save new MeasurementSheet
// async function saveMeasurementSheet() {

//   const name = document.getElementById('MeasurementSheetName').value.trim();
//   if (!name) {
//     alert("Measurement Sheet name required");
//     return;
//   }

//   const under = [];
//   document.querySelectorAll('.under-input').forEach(i => {
//     if (i.value.trim()) under.push(i.value.trim());
//   });

//   const forItem = [];
//   document.querySelectorAll('.foritem-input').forEach(i => {
//     if (i.value.trim()) forItem.push(i.value.trim());
//   });

//   const data = {
//     MeasurementSheetName: name,
//     under,
//     forItem,
//     updatedAt: new Date().toISOString()
//   };

//   try {

//     if (editingSheetId) {
//       // ✅ UPDATE
//       await database.ref(`measurementSheet/${editingSheetId}`).update(data);
//     } else {
//       // ✅ CREATE
//       await database.ref('measurementSheet').push({
//         ...data,
//         createdBy: currentUser.uid,
//         createdAt: new Date().toISOString()
//       });
//     }

//     resetModal();
//     loadmeasurementSheet();

//   } catch (err) {
//     alert(err.message);
//   }
// }

async function saveMeasurementSheet() {

  const name = document.getElementById('MeasurementSheetName').value.trim();
  if (!name) {
    alert("Measurement Sheet name required");
    return;
  }

  const under = [];
  document.querySelectorAll('.under-input').forEach(i => {
    if (i.value.trim()) under.push(i.value.trim());
  });

  const forItem = [];
  document.querySelectorAll('.foritem-input').forEach(i => {
    if (i.value.trim()) forItem.push(i.value.trim());
  });

  const data = {
    MeasurementSheetName: name,
    under,
    forItem
  };

  try {

    if (editingSheetId) {
      // ✅ UPDATE (no updatedAt)
      await database.ref(`measurementSheet/${editingSheetId}`).update(data);
    } else {
      // ✅ CREATE (no createdAt / createdBy)
      await database.ref('measurementSheet').push(data);
    }

    resetModal();
    loadmeasurementSheet();

  } catch (err) {
    alert(err.message);
  }
}




// Delete MeasurementSheet
async function deleteMeasurementSheet(MeasurementSheetId, MeasurementSheetName) {

  // ✅ Use userRole from all.js
  if (userRole !== 'admin') {
    alert('Only administrators can delete Measurement Sheets');
    return;
  }

  if (!confirm(
    `Are you sure you want to delete Measurement Sheet "${MeasurementSheetName}"?\nThis action cannot be undone.`
  )) {
    return;
  }

  try {
    // ✅ Delete the MeasurementSheet
    await database.ref(`measurementSheet/${MeasurementSheetId}`).remove();
    console.log("MeasurementSheet deleted:", MeasurementSheetId);

    // ✅ Remove MeasurementSheet reference from all users
    const usersSnapshot = await database.ref('users').once('value');
    const users = usersSnapshot.val();

    if (users) {
      const updates = {};

      Object.keys(users).forEach(userId => {
        if (
          users[userId].measurementSheet &&
          users[userId].measurementSheet[MeasurementSheetId]
        ) {
          updates[`users/${userId}/measurementSheet/${MeasurementSheetId}`] = null;
        }
      });

      if (Object.keys(updates).length > 0) {
        await database.ref().update(updates);
      }
    }

    // ✅ Reload list
    await loadmeasurementSheet();

  } catch (error) {
    console.error("Error deleting MeasurementSheet:", error);
    alert('Error deleting MeasurementSheet: ' + error.message);
  }
}


  // Helper function to format date
  function formatDate(dateString) {
    if (!dateString) return 'Unknown date';
    
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return 'Invalid date';
      
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch (error) {
      console.error("Error formatting date:", error);
      return 'Invalid date';
    }
  }

  // Helper function to escape HTML (prevents XSS)
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Add event listener for Enter key in MeasurementSheet name input
  document.addEventListener('DOMContentLoaded', function() {
    const MeasurementSheetNameInput = document.getElementById('MeasurementSheetName');
    if (MeasurementSheetNameInput) {
      MeasurementSheetNameInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          saveMeasurementSheet();
        }
      });
    }    
  });



function addUnderField(value = "") {
  const div = document.createElement("div");
  div.className = "input-group mb-2 position-relative";

  div.innerHTML = `
    <input type="text" class="form-control under-input"
           placeholder="Enter Under" value="${value}">
    <button class="btn btn-outline-danger" onclick="this.parentElement.remove()">
      <i class="bi bi-x"></i>
    </button>
  `;

  document.getElementById("underList").appendChild(div);

  const input = div.querySelector(".under-input");
  attachItemAutocomplete(input);
}


function addForItemField(value = "") {
  const div = document.createElement("div");
  div.className = "input-group mb-2 position-relative";

  div.innerHTML = `
    <input type="text" class="form-control foritem-input"
           placeholder="Enter Item" value="${value}">
    <button class="btn btn-outline-danger" onclick="this.parentElement.remove()">
      <i class="bi bi-x"></i>
    </button>
  `;

  document.getElementById("forItemList").appendChild(div);

  const input = div.querySelector(".foritem-input");
  attachItemAutocomplete(input);
}



function resetModal() {
  editingSheetId = null;

  document.getElementById('MeasurementSheetName').value = '';
  document.getElementById('underList').innerHTML = '';
  document.getElementById('forItemList').innerHTML = '';

  document.querySelector('#createMeasurementSheetModal .modal-title')
    .innerText = "Create Sheet";

  const modalEl = document.getElementById('createMeasurementSheetModal');
  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.hide();
}

document
  .getElementById('createMeasurementSheetModal')
  .addEventListener('hidden.bs.modal', () => {
    editingSheetId = null;
    document.getElementById('MeasurementSheetName').value = '';
    document.getElementById('underList').innerHTML = '';
    document.getElementById('forItemList').innerHTML = '';

    document.querySelector('#createMeasurementSheetModal .modal-title')
      .innerText = "Create Sheet";
  });



/* =========================
   auto-suggest (autocomplete)
========================= */
let ITEM_SUGGESTIONS = [];

async function loadItemSuggestions() {
  try {
    const res = await fetch("js/measurement.json");
    const data = await res.json();
    ITEM_SUGGESTIONS = data.UnderForDropdowns || [];
  } catch (err) {
    console.error("Failed to load item suggestions", err);
  }
}


function attachItemAutocomplete(input) {

  // wrapper must be position-relative
  const wrapper = input.parentElement;
  wrapper.style.position = "relative";

  const box = document.createElement("div");
  box.className = "item-suggest-box";
  wrapper.appendChild(box);

  // Inject CSS once
  if (!document.getElementById("itemAutoCSS")) {
    const style = document.createElement("style");
    style.id = "itemAutoCSS";
    style.innerHTML = `
      .item-suggest-box {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        z-index: 9999;
      }
      .item-suggest-list {
        background: #fff;
        border: 1px solid #ced4da;
        border-radius: 6px;
        max-height: 180px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,.1);
      }
      .item-suggest-item {
        padding: 6px 10px;
        cursor: pointer;
        font-size: 13px;
      }
      .item-suggest-item:hover {
        background: #0d6efd;
        color: #fff;
      }
    `;
    document.head.appendChild(style);
  }

  input.addEventListener("input", () => {
    const val = input.value.trim().toLowerCase();
    box.innerHTML = "";

    if (!val) return;

    const matches = ITEM_SUGGESTIONS.filter(item =>
      item.toLowerCase().startsWith(val)
    );

    if (!matches.length) return;

    const list = document.createElement("div");
    list.className = "item-suggest-list";

    matches.forEach(item => {
      const div = document.createElement("div");
      div.className = "item-suggest-item";
      div.textContent = item;

      div.onclick = () => {
        input.value = item;
        box.innerHTML = "";
      };

      list.appendChild(div);
    });

    box.appendChild(list);
  });

  document.addEventListener("click", e => {
    if (!wrapper.contains(e.target)) {
      box.innerHTML = "";
    }
  });
}





/* =========================
   Export to Excel Function
========================= */
async function exportSheetToExcel(sheetId, sheetName) {
    try {
        // Fetch sheet data
        const snapshot = await database.ref(`measurementSheet/${sheetId}/items`).once('value');
        const itemsData = snapshot.val();
        
        if (!itemsData) {
            alert('No data to export');
            return;
        }
        
        // Prepare data array
        const rows = [];
        
        // Add headers
        const headers = ['Under', 'For Item', 'Item Description', 'Nos', 'Length', 'Width', 'Thickness', 'Unit', 'Total'];
        rows.push(headers);
        
        // Add data rows
        Object.keys(itemsData).forEach(key => {
            const item = itemsData[key];
            rows.push([
                item.under || '',
                item.forItem || '',
                item.item || '',
                item.nos || 0,
                item.l || 0,
                item.w || 0,
                item.t || 0,
                item.unit || '',
                item.total || 0
            ]);
        });
        
        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(rows);
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
        
        // Generate filename
        const fileName = `${sheetName}_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        // Export file
        XLSX.writeFile(wb, fileName);
        
    } catch (error) {
        console.error('Error exporting to Excel:', error);
        alert('Failed to export to Excel: ' + error.message);
    }
}
</script>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>