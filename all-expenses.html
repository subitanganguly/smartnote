<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartNote V2</title>
    <link rel="icon" type="image/png" href="img/logo.png">
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="js/gradient-loader.js"></script>
    <script src="js/auth.js"></script>
</head>
  <body>
     <div class="area" >
        <ul class="circles">
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
        </ul>

        <nav class="navbar bg-light fixed-top">
  <div class="container">
    <a class="navbar-brand" href="#">
    <img src="img/logo.png" alt="Bootstrap" width="40" height="34" class="brand-logo">
    <span id="greetingMessage" class="mb-0">All Expenses</span>
    </a>
    <div class="d-flex align-items-center">
        <a class="dropdown-item" alt="Log Out" href="#" id="logoutButton"><i class="fa-solid fa-right-from-bracket"></i></a>
    
    </div>
  </div>
   </nav>
  
   <div class="container main-content" style="margin-top: 80px;">
      <div class="container mt-1">
        <div class="row g-2">
        <!-- Search input -->
        <div class="col-md-6">
            <div class="input-group zoom mb-1">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="searchInput" class="form-control" placeholder="Search..." onkeyup="filterExpenses()">
            </div>
        </div>

        <!-- Label filter -->
        <div class="col-md-6">
            <select id="labelFilter" class="form-select mb-1 zoom text-uppercase">
            <option value="">All Labels</option>
            </select>
        </div>
        </div>


        <button id="resetFilter" class="btn btn-outline-light me-1 mb-2 btn-res" onclick="resetFilters()">
            <i class="fas fa-filter"></i> Reset
        </button>

        <button id="downloadExcel" class="btn btn-outline-success mb-2 btn-res">
            <i class="fas fa-file-excel"></i> Excel
        </button><br>

        <button class="btn btn-outline-light btn-res">
            <span id="totalAmount">₹ Total</span>
        </button>

        <center>
            <div id="loadingSpinner" class="loader mt-3" style="display: none;" role="status">
                <span class="sr-only"></span>
            </div>
        </center>

        <ul id="expensesList" class="list-group mt-3"></ul>
    </div>

    <script>
        const loadingSpinner = document.getElementById("loadingSpinner");
        const expensesList = document.getElementById("expensesList");
        const searchInput = document.getElementById("searchInput");
        const totalAmount = document.getElementById("totalAmount");

        let expensesData = [];

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                const userId = user.uid;
                loadAllExpenses(userId);
                loadLabels(userId);
            } else {
                console.log("User not authenticated. Redirecting...");
                window.location.href = "login.html";
            }
        });

        function loadAllExpenses(userId) {
            expensesData = [];
            loadingSpinner.style.display = "flex";

            const archiveRef = firebase.database().ref(`archive_expenses/${userId}`);
            const expensesRef = firebase.database().ref(`expenses/${userId}`);

            Promise.all([
                archiveRef.once("value"),
                expensesRef.once("value")
            ]).then(([archiveSnapshot, expensesSnapshot]) => {
                expensesData = [];

                archiveSnapshot.forEach((childSnapshot) => {
                    const expense = childSnapshot.val();
                    expense.key = childSnapshot.key;
                    expense.isArchived = true;
                    expensesData.push(expense);
                });

                expensesSnapshot.forEach((childSnapshot) => {
                    const expense = childSnapshot.val();
                    expense.key = childSnapshot.key;
                    expense.isArchived = false;
                    expensesData.push(expense);
                });

                displayExpenses(expensesData);
                loadingSpinner.style.display = "none";
            });
        }


        function loadLabels(userId) {
    const labelFilter = document.getElementById("labelFilter");
    const labels = new Set();

    const archiveRef = firebase.database().ref(`archive_expenses/${userId}`);
    const expensesRef = firebase.database().ref(`expenses/${userId}`);

    Promise.all([archiveRef.once("value"), expensesRef.once("value")]).then(([archiveSnapshot, expensesSnapshot]) => {
        archiveSnapshot.forEach(childSnapshot => {
            const expense = childSnapshot.val();
            if (expense.label) {
                labels.add(expense.label);
            }
        });

        expensesSnapshot.forEach(childSnapshot => {
            const expense = childSnapshot.val();
            if (expense.label) {
                labels.add(expense.label);
            }
        });

        labelFilter.innerHTML = '<option value="">All Labels</option>';
        labels.forEach(label => {
            const option = document.createElement("option");
            option.value = label;
            option.textContent = label;
            labelFilter.appendChild(option);
        });
    });
}


document.getElementById("labelFilter").addEventListener("change", function () {
    const selectedLabel = this.value;
    if (selectedLabel === "") {
        displayExpenses(expensesData); // Show all expenses if "All Labels" is selected
    } else {
        const filteredExpenses = expensesData.filter(expense => expense.label && expense.label === selectedLabel);
        displayExpenses(filteredExpenses);
    }
});


function displayExpenses(expenses) {
    expensesList.innerHTML = "";
    if (expenses.length === 0) {
        expensesList.innerHTML = `<li class="text-center glass zoom text-light">No records found</li>`;
        totalAmount.textContent = "Total: ₹0.00 | Records: 0";
        return;
    }

    let total = 0;
    expenses.forEach((expense) => {
        total += expense.amount;
        const formattedDate = new Date(expense.date).toLocaleDateString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });

        const listItem = document.createElement("li");
        listItem.classList.add("group-item", "text-light");

        listItem.innerHTML = `
            <div class="glass mb-2 text-light text-uppercase zoom p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div style="margin-left: 20px;">
                        <span style="font-size: 12px; color: #ffc107;">
                            <b><i class="fas fa-wallet"></i> ${expense.description}</b> 
                            <span class="text-light"> ₹${expense.amount.toFixed(2)}</span><br>
                            <span style="font-size: 12px; color: #32CD32;"> ${formattedDate}</span>
                        </span>
                    </div>
                    <button class="btn btn-outline-danger btn-sm delete-btn" data-key="${expense.key}" data-archived="${expense.isArchived}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        expensesList.appendChild(listItem);
    });

    // Add event listeners to delete buttons
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const expenseKey = this.getAttribute('data-key');
            const isArchived = this.getAttribute('data-archived') === 'true';
            deleteExpense(expenseKey, isArchived);
        });
    });

    totalAmount.textContent = `Total: ₹${total.toFixed(2)} | Records: ${expenses.length}`;
}

        function deleteExpense(expenseKey, isArchived) {
            if (!confirm("Are you sure you want to delete this expense?")) {
                return;
            }

            const user = firebase.auth().currentUser;
            if (!user) return;

            const userId = user.uid;
            const expenseRef = isArchived 
                ? firebase.database().ref(`archive_expenses/${userId}/${expenseKey}`)
                : firebase.database().ref(`expenses/${userId}/${expenseKey}`);

            expenseRef.remove()
                .then(() => {
                    // Remove from local data and refresh display
                    expensesData = expensesData.filter(expense => 
                        !(expense.key === expenseKey && expense.isArchived === isArchived)
                    );
                    displayExpenses(expensesData);
                   // alert("Expense deleted successfully!");
                })
                .catch((error) => {
                    alert("Error deleting expense: " + error.message);
                });
        }

        function filterExpenses() {
            const searchText = searchInput.value.toLowerCase();
            const filteredExpenses = expensesData.filter(expense =>
                expense.description.toLowerCase().includes(searchText)
            );
            displayExpenses(filteredExpenses);
        }

        function resetFilters() {
            searchInput.value = "";
            displayExpenses(expensesData);
        }

        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = "index.html";
            }
        }

        document.getElementById("logoutButton").addEventListener("click", () => {
            firebase.auth().signOut().then(() => {
                window.location.href = "login.html";
            }).catch((error) => {
                alert("Error logging out: " + error.message);
            });
        });

        document.getElementById("downloadExcel").addEventListener("click", function () {
            if (expensesData.length === 0) {
                alert("No expenses to download!");
                return;
            }

            const data = expensesData.map(expense => ({
                Title: expense.description,
                Amount: `₹${expense.amount.toFixed(2)}`,
                Date: new Date(expense.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "All Expenses");
            XLSX.writeFile(wb, "All_Expenses.xlsx");
        });

    </script>
   
   </div>
  </div>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    
  </body>
</html>